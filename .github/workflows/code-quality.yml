name: AnÃ¡lise de Qualidade de CÃ³digo

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Executa toda segunda-feira Ã s 2h UTC
    - cron: '0 2 * * 1'

jobs:
  # âœ… FASE 12.12: AnÃ¡lise estÃ¡tica de cÃ³digo
  static-analysis:
    name: AnÃ¡lise EstÃ¡tica
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Configurar JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Dar permissÃ£o ao Gradle Wrapper
        run: chmod +x gradlew
      
      - name: Executar detekt (anÃ¡lise estÃ¡tica Kotlin)
        run: |
          # Verificar se detekt estÃ¡ configurado, se nÃ£o, pular
          if [ -f "detekt.yml" ] || grep -q "detekt" build.gradle.kts; then
            ./gradlew detekt --no-daemon
          else
            echo "âš ï¸ Detekt nÃ£o configurado, pulando anÃ¡lise estÃ¡tica"
          fi
        continue-on-error: true
      
      - name: Executar ktlint (formataÃ§Ã£o Kotlin)
        run: |
          # Verificar se ktlint estÃ¡ configurado
          if grep -q "ktlint" build.gradle.kts; then
            ./gradlew ktlintCheck --no-daemon
          else
            echo "âš ï¸ ktlint nÃ£o configurado, pulando verificaÃ§Ã£o de formataÃ§Ã£o"
          fi
        continue-on-error: true
      
      - name: Contar linhas de cÃ³digo
        run: |
          echo "ğŸ“Š EstatÃ­sticas do CÃ³digo:"
          echo "Total de arquivos Kotlin:"
          find app/src -name "*.kt" | wc -l
          echo "Total de linhas de cÃ³digo Kotlin:"
          find app/src -name "*.kt" -exec wc -l {} + | tail -1
          echo "Total de arquivos XML:"
          find app/src -name "*.xml" | wc -l
      
      - name: Verificar complexidade ciclomÃ¡tica
        run: |
          echo "ğŸ” Verificando complexidade do cÃ³digo..."
          # Contar mÃ©todos/funÃ§Ãµes por arquivo
          find app/src/main -name "*.kt" -exec sh -c 'echo "{}: $(grep -c "fun " "{}" 2>/dev/null || echo 0)"' \;
        continue-on-error: true

  # âœ… FASE 12.12: VerificaÃ§Ã£o de seguranÃ§a
  security-scan:
    name: VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Verificar dependÃªncias vulnerÃ¡veis
        run: |
          echo "ğŸ”’ Verificando dependÃªncias vulnerÃ¡veis..."
          ./gradlew dependencies --no-daemon | grep -i "vulnerable\|CVE" || echo "âœ… Nenhuma vulnerabilidade conhecida encontrada"
        continue-on-error: true
      
      - name: Verificar secrets no cÃ³digo
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true
      
      - name: Verificar permissÃµes do AndroidManifest
        run: |
          echo "ğŸ” Verificando permissÃµes declaradas..."
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            grep -n "uses-permission" app/src/main/AndroidManifest.xml || echo "Nenhuma permissÃ£o encontrada"
          fi

