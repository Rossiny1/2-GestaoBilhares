# Script PowerShell para criar local.properties no Windows
# Uso: .\scripts\criar-local-properties-windows.ps1

$ErrorActionPreference = "Continue"

Write-Host "üîß Criando local.properties para Windows..." -ForegroundColor Cyan
Write-Host ""

# Verificar se j√° existe
if (Test-Path "local.properties") {
    Write-Host "‚ö†Ô∏è  local.properties j√° existe!" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Conte√∫do atual:" -ForegroundColor Cyan
    Get-Content local.properties
    Write-Host ""
    $sobrescrever = Read-Host "Deseja sobrescrever? (S/N)"
    if ($sobrescrever -ne "S" -and $sobrescrever -ne "s") {
        Write-Host "Opera√ß√£o cancelada." -ForegroundColor Yellow
        exit 0
    }
}

# Tentar encontrar Android SDK automaticamente
Write-Host "üîç Procurando Android SDK..." -ForegroundColor Yellow

$sdkPaths = @(
    "$env:LOCALAPPDATA\Android\Sdk",
    "$env:USERPROFILE\AppData\Local\Android\Sdk",
    "C:\Android\Sdk",
    "$env:ANDROID_HOME",
    "$env:ANDROID_SDK_ROOT"
)

$sdkPath = $null
foreach ($path in $sdkPaths) {
    if ($path -and (Test-Path $path)) {
        $sdkPath = $path
        Write-Host "‚úÖ Android SDK encontrado em: $sdkPath" -ForegroundColor Green
        break
    }
}

# Se n√£o encontrou, pedir ao usu√°rio
if (-not $sdkPath) {
    Write-Host "‚ùå Android SDK n√£o encontrado automaticamente." -ForegroundColor Red
    Write-Host ""
    Write-Host "üí° Como encontrar o caminho:" -ForegroundColor Cyan
    Write-Host "   1. Abra Android Studio" -ForegroundColor Gray
    Write-Host "   2. File ‚Üí Settings ‚Üí Appearance & Behavior ‚Üí System Settings ‚Üí Android SDK" -ForegroundColor Gray
    Write-Host "   3. Copie o caminho mostrado" -ForegroundColor Gray
    Write-Host ""
    $sdkPath = Read-Host "Digite o caminho do Android SDK"
    
    # Validar caminho
    if (-not (Test-Path $sdkPath)) {
        Write-Host "‚ùå Caminho n√£o encontrado: $sdkPath" -ForegroundColor Red
        Write-Host "üí° Verifique o caminho e tente novamente." -ForegroundColor Yellow
        exit 1
    }
}

# Converter caminho para formato do Gradle (escapar barras)
$sdkPathEscaped = $sdkPath -replace '\\', '\\'

# Criar arquivo
$content = @"
## This file is automatically generated by Android Studio.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file should *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.
#
# Location of the SDK. This is only used by Gradle.
# For customization when using a Version Control System, please read the
# header note.
sdk.dir=$sdkPathEscaped
"@

$content | Out-File -FilePath "local.properties" -Encoding UTF8 -NoNewline

Write-Host ""
Write-Host "‚úÖ local.properties criado com sucesso!" -ForegroundColor Green
Write-Host ""
Write-Host "üìÑ Conte√∫do:" -ForegroundColor Cyan
Get-Content local.properties
Write-Host ""
Write-Host "üß™ Testando build..." -ForegroundColor Yellow

# Testar se funciona
$testResult = .\gradlew.bat compileDebugKotlin --console=plain 2>&1 | Select-String -Pattern "BUILD SUCCESS|BUILD FAILED" | Select-Object -First 1

if ($testResult -match "BUILD SUCCESS") {
    Write-Host "‚úÖ Build passou! Tudo configurado corretamente!" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  Build ainda falhou. Verifique os erros acima." -ForegroundColor Yellow
    Write-Host "üí° Execute: .\scripts\diagnostico-build-local.ps1 para mais detalhes" -ForegroundColor Cyan
}

Write-Host ""
