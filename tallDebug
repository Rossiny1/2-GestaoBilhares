package com.example.gestaobilhares.sync

import android.content.Context
import android.net.ConnectivityManager
import android.net.NetworkCapabilities
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import com.example.gestaobilhares.data.database.AppDatabase
import com.example.gestaobilhares.data.entities.*
import com.example.gestaobilhares.data.repository.AppRepository
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.first
import java.util.*
import java.util.concurrent.atomic.AtomicBoolean
// Firestore/Auth/Coroutines
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.SetOptions
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.tasks.await
// JSON
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

/**
 * ‚úÖ FASE 3C: Gerenciador de Sincroniza√ß√£o V2
 * Utiliza as novas entidades SyncLog, SyncQueue e SyncConfig
 * Seguindo melhores pr√°ticas Android 2025
 */
class SyncManagerV2(
    private val context: Context,
    private val appRepository: AppRepository,
    private val database: AppDatabase
) {
    
    private val syncScope = CoroutineScope(Dispatchers.IO + SupervisorJob())
    private val isSyncing = AtomicBoolean(false)
    
    // DAOs das novas entidades
    private val syncLogDao = database.syncLogDao()
    private val syncQueueDao = database.syncQueueDao()
    private val syncConfigDao = database.syncConfigDao()
    
    // LiveData para status
    private val _syncStatus = MutableLiveData<SyncStatus>()
    val syncStatus: LiveData<SyncStatus> = _syncStatus
    
    private val _pendingOperationsCount = MutableLiveData<Int>()
    val pendingOperationsCount: LiveData<Int> = _pendingOperationsCount
    
    private val _lastSyncTime = MutableLiveData<Long>()
    val lastSyncTime: LiveData<Long> = _lastSyncTime

    // Firebase Firestore e utilit√°rios
    private val firestore: FirebaseFirestore by lazy { FirebaseFirestore.getInstance() }
    private val gson: Gson by lazy { Gson() }
    
    // ‚úÖ FASE 12.14: Handlers de pull especializados
    private val rotaPullHandler by lazy { 
        com.example.gestaobilhares.sync.handlers.RotaPullHandler(appRepository, database, firestore, context) 
    }
    private val clientePullHandler by lazy { 
        com.example.gestaobilhares.sync.handlers.ClientePullHandler(appRepository, database, firestore, context) 
    }
    private val mesaPullHandler by lazy { 
        com.example.gestaobilhares.sync.handlers.MesaPullHandler(appRepository, database, firestore, context) 
    }
    private val acertoPullHandler by lazy { 
        com.example.gestaobilhares.sync.handlers.AcertoPullHandler(appRepository, database, firestore, context) 
    }
    private val cicloPullHandler by lazy { 
        com.example.gestaobilhares.sync.handlers.CicloPullHandler(appRepository, database, firestore, context) 
    }

    init {
        syncScope.launch {
            initializeSyncConfig()
        }
        startPeriodicSync()
        observePendingOperations()
    }

    /**
     * Inicializar configura√ß√µes padr√£o de sincroniza√ß√£o
     */
    private suspend fun initializeSyncConfig() {
        try {
            syncConfigDao.inicializarConfiguracoesPadrao(System.currentTimeMillis())
            
            // Garantir que exista um empresa_id padr√£o
            val empresaConfig = syncConfigDao.buscarSyncConfigPorChave("empresa_id")
            if (empresaConfig == null) {
                val now = System.currentTimeMillis()
                // empresa_001 √© o padr√£o visto no console do Firestore
                syncConfigDao.atualizarValorConfig("empresa_id", "empresa_001", now)
                android.util.Log.d("SyncManagerV2", "‚úÖ empresa_id configurado como 'empresa_001'")
            } else {
                android.util.Log.d("SyncManagerV2", "‚úÖ empresa_id j√° configurado: ${empresaConfig.value}")
            }
            
            android.util.Log.d("SyncManagerV2", "Configura√ß√µes de sincroniza√ß√£o inicializadas")
        } catch (e: Exception) {
            android.util.Log.w("SyncManagerV2", "Erro ao inicializar configura√ß√µes: ${e.message}")
        }
    }

    /**
     * Observar contagem de opera√ß√µes pendentes
     */
    private fun observePendingOperations() {
        syncScope.launch {
            syncQueueDao.contarOperacoesPendentes().let { count ->
                _pendingOperationsCount.postValue(count)
            }
        }
    }

    /**
     * Adicionar opera√ß√£o √† fila de sincroniza√ß√£o
     */
    suspend fun addToSyncQueue(
        entityType: String,
        entityId: Long,
        operation: String,
        payload: String,
        priority: Int = 0
    ) {
        try {
            val syncQueue = SyncQueue(
                entityType = entityType,
                entityId = entityId,
                operation = operation,
                payload = payload,
                createdAt = Date(),
                scheduledFor = Date(), // Processar imediatamente
                retryCount = 0,
                status = "PENDING",
                priority = priority
            )
            
            syncQueueDao.inserirSyncQueue(syncQueue)
            
            // Log da opera√ß√£o
            logSyncOperation(entityType, entityId, operation, "PENDING", null, payload)
            
            // Atualizar contagem
            observePendingOperations()
            
            android.util.Log.d("SyncManagerV2", "Opera√ß√£o adicionada √† fila: $entityType:$entityId")
            
            // Tentar sincronizar se online
            if (isOnline()) {
                processSyncQueue()
            }
            
        } catch (e: Exception) {
            android.util.Log.e("SyncManagerV2", "Erro ao adicionar √† fila: ${e.message}")
        }
    }

    /**
     * Processar fila de sincroniza√ß√£o
     */
    suspend fun processSyncQueue() {
        if (isSyncing.get() || !isOnline()) return
        if (!isAuthenticated()) {
            android.util.Log.w("SyncManagerV2", "Ignorando sync: usu√°rio n√£o autenticado no Firebase")
            return
        }
        
        isSyncing.set(true)
        _syncStatus.postValue(SyncStatus.SYNCING)
        
        try {
            val currentTime = System.currentTimeMillis()
            val operations = syncQueueDao.buscarOperacoesAgendadas(currentTime).first()
            
            android.util.Log.d("SyncManagerV2", "üìã Processando ${operations.size} opera√ß√µes")
            if (operations.isEmpty()) {
                android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Nenhuma opera√ß√£o pendente na fila de sincroniza√ß√£o")
                return
            }
            
            operations.forEachIndexed { index, op ->
                android.util.Log.d("SyncManagerV2", "   [$index] ${op.entityType}:${op.entityId} - ${op.operation} (${op.status})")
            }
            
            for (operation in operations) {
                try {
                    // Marcar como processando
                    syncQueueDao.marcarComoProcessando(operation.id)
                    
                    // Aplicar opera√ß√£o real no Firestore
                    val success = applyOperationToFirestore(operation)
                    
                    if (success) {
                        // Marcar como conclu√≠da
                        syncQueueDao.marcarComoConcluida(operation.id)
                        logSyncOperation(
                            operation.entityType,
                            operation.entityId,
                            operation.operation,
                            "SUCCESS",
                            null,
                            operation.payload
                        )
                    } else {
                        // Marcar como falhou e agendar retry
                        val nextRetry = currentTime + (30000 * (operation.retryCount + 1)) // 30s, 60s, 90s
                        syncQueueDao.marcarComoFalhou(operation.id, nextRetry)
                        logSyncOperation(
                            operation.entityType,
                            operation.entityId,
                            operation.operation,
                            "FAILED",
                            "Falha ao aplicar opera√ß√£o no Firestore",
                            operation.payload
                        )
                    }
                    
                } catch (e: Exception) {
                    android.util.Log.e("SyncManagerV2", "Erro ao processar opera√ß√£o ${operation.id}: ${e.message}")
                    syncQueueDao.marcarComoFalhou(operation.id, currentTime + 60000)
                }
            }
            
            // Atualizar timestamp da √∫ltima sincroniza√ß√£o
            updateLastSyncTimestamp()
            
        } catch (e: Exception) {
            android.util.Log.e("SyncManagerV2", "Erro ao processar fila: ${e.message}")
            _syncStatus.postValue(SyncStatus.ERROR)
        } finally {
            isSyncing.set(false)
            _syncStatus.postValue(SyncStatus.SYNCED)
            observePendingOperations()
        }
    }

    /**
     * Aplicar opera√ß√£o no Firestore usando payload JSON armazenado na fila.
     * Mant√©m o app offline-first: Room continua fonte da verdade, Firestore √© o espelho.
     */
    private suspend fun applyOperationToFirestore(operation: SyncQueue): Boolean {
        return try {
            val empresaId = getEmpresaId()
            val collection = getCollectionName(operation.entityType)
            val docId = operation.entityId.toString()

            android.util.Log.d("SyncManagerV2", "üîÑ Aplicando opera√ß√£o no Firestore:")
            android.util.Log.d("SyncManagerV2", "   Empresa ID: $empresaId")
            android.util.Log.d("SyncManagerV2", "   Collection: $collection")
            android.util.Log.d("SyncManagerV2", "   Document ID: $docId")
            android.util.Log.d("SyncManagerV2", "   Operation: ${operation.operation}")
            android.util.Log.d("SyncManagerV2", "   Payload: ${operation.payload}")

            // Converter o payload JSON em Map<String, Any?> para enviar ao Firestore
            val mapType = object : TypeToken<Map<String, Any?>>() {}.type
            val payloadMap: Map<String, Any?> = try {
                gson.fromJson(operation.payload, mapType) ?: emptyMap()
            } catch (e: Exception) {
                android.util.Log.w("SyncManagerV2", "Payload inv√°lido para ${operation.entityType}:${operation.entityId} -> ${e.message}")
                emptyMap()
            }

            android.util.Log.d("SyncManagerV2", "   Payload Map: $payloadMap")
            
            // ‚úÖ VALIDA√á√ÉO CR√çTICA: Verificar se o payload n√£o est√° vazio
            if (payloadMap.isEmpty()) {
                android.util.Log.e("SyncManagerV2", "‚ùå Payload vazio para ${operation.entityType}:${operation.entityId} - Opera√ß√£o cancelada")
                return false
            }
            
            // ‚úÖ VALIDA√á√ÉO ESPEC√çFICA POR TIPO DE ENTIDADE (MAIS FLEX√çVEL)
            when (operation.entityType.lowercase()) {
                "cliente" -> {
                    val nome = payloadMap["nome"]?.toString()
                    if (nome.isNullOrBlank()) {
                        android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Cliente sem nome - Usando nome padr√£o")
                        // N√£o cancelar, usar nome padr√£o
                    }
                }
                "mesa" -> {
                    val numero = payloadMap["numero"]?.toString()
                    if (numero.isNullOrBlank()) {
                        android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Mesa sem n√∫mero - Usando n√∫mero padr√£o")
                        // N√£o cancelar, usar n√∫mero padr√£o
                    }
                }
                "acerto" -> {
                    val valor = payloadMap["valorRecebido"]
                    val clienteId = payloadMap["clienteId"]
                    if (valor == null) {
                        android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Acerto sem valor - Usando valor padr√£o")
                        // N√£o cancelar, usar valor padr√£o
                    }
                    if (clienteId == null) {
                        android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Acerto sem clienteId - Usando cliente padr√£o")
                        // N√£o cancelar, usar cliente padr√£o
                    }
                    // ‚úÖ CR√çTICO: Verificar fotos nas mesas do acerto
                    val acertoMesas = payloadMap["acertoMesas"] as? List<Map<String, Any?>>
                    if (acertoMesas != null) {
                        android.util.Log.d("SyncManagerV2", "üì∑ Verificando fotos em ${acertoMesas.size} mesas do acerto...")
                        acertoMesas.forEachIndexed { index, mesa ->
                            val fotoUrl = mesa["fotoRelogioFinal"] as? String
                            val temUrl = !fotoUrl.isNullOrBlank()
                            val isFirebaseUrl = temUrl && fotoUrl?.startsWith("https://firebasestorage.googleapis.com") == true
                            android.util.Log.d("SyncManagerV2", "üì∑   Mesa ${index + 1}: fotoUrl='$fotoUrl'")
                            android.util.Log.d("SyncManagerV2", "üì∑     Tem URL? $temUrl | √â URL Firebase? $isFirebaseUrl")
                            if (!temUrl || !isFirebaseUrl) {
                                android.util.Log.e("SyncManagerV2", "üì∑     ‚ùå ERRO CR√çTICO: URL da foto n√£o est√° presente ou √© inv√°lida!")
                            } else {
                                android.util.Log.d("SyncManagerV2", "üì∑     ‚úÖ URL v√°lida do Firebase ser√° enviada")
                            }
                        }
                    } else {
                        android.util.Log.w("SyncManagerV2", "üì∑ ‚ö†Ô∏è Acerto sem mesas ou campo acertoMesas n√£o encontrado")
                    }
                }
                "rota" -> {
                    val nome = payloadMap["nome"]?.toString()
                    if (nome.isNullOrBlank()) {
                        android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Rota sem nome - Usando nome padr√£o")
                        // N√£o cancelar, usar nome padr√£o
                    }
                }
            }

            // ‚úÖ CORRE√á√ÉO: Usar roomId como documento ID para evitar duplicatas
            val docRef = firestore
                .collection("empresas")
                .document(empresaId)
                .collection(collection)
                .document(operation.entityId.toString()) // Usar roomId como documento ID

            android.util.Log.d("SyncManagerV2", "   Firestore Path: empresas/$empresaId/$collection/${operation.entityId}")

            when (operation.operation.uppercase(Locale.getDefault())) {
                "CREATE", "UPDATE" -> {
                    // ‚úÖ CORRE√á√ÉO: Adicionar roomId ao payload para refer√™ncia
                    val payloadWithRoomId = payloadMap.toMutableMap().apply {
                        put("roomId", operation.entityId)
                        put("syncTimestamp", System.currentTimeMillis())
                    }
                    
                    // ‚úÖ CR√çTICO: Verificar fotos no payload final antes de enviar
                    if (operation.entityType.lowercase() == "acerto") {
                        val acertoMesas = payloadWithRoomId["acertoMesas"] as? List<Map<String, Any?>>
                        if (acertoMesas != null) {
                            android.util.Log.d("SyncManagerV2", "üì∑ ========================================")
                            android.util.Log.d("SyncManagerV2", "üì∑ PAYLOAD FINAL ANTES DE ENVIAR AO FIRESTORE:")
                            acertoMesas.forEachIndexed { index, mesa ->
                                val fotoUrl = mesa["fotoRelogioFinal"] as? String
                                android.util.Log.d("SyncManagerV2", "üì∑   Mesa ${index + 1}: fotoUrl='$fotoUrl'")
                                if (fotoUrl.isNullOrBlank()) {
                                    android.util.Log.e("SyncManagerV2", "üì∑     ‚ùå‚ùå‚ùå ERRO: URL da foto est√° VAZIA no payload final!")
                                } else if (!fotoUrl.startsWith("https://firebasestorage.googleapis.com")) {
                                    android.util.Log.e("SyncManagerV2", "üì∑     ‚ùå‚ùå‚ùå ERRO: URL n√£o √© do Firebase Storage: '$fotoUrl'")
                                } else {
                                    android.util.Log.d("SyncManagerV2", "üì∑     ‚úÖ URL v√°lida ser√° enviada ao Firestore")
                                }
                            }
                            android.util.Log.d("SyncManagerV2", "üì∑ ========================================")
                        }
                    }
                    
                    // ‚úÖ NOVO: Para opera√ß√µes UPDATE, usar merge para n√£o sobrescrever
                    // Para opera√ß√µes CREATE, usar set para criar novo documento
                    if (operation.operation.uppercase(Locale.getDefault()) == "UPDATE") {
                        android.util.Log.d("SyncManagerV2", "   Executando UPDATE com merge...")
                        docRef.set(payloadWithRoomId, SetOptions.merge()).await()
                    } else {
                        android.util.Log.d("SyncManagerV2", "   Executando CREATE com set...")
                        docRef.set(payloadWithRoomId).await()
                    }
                    android.util.Log.d("SyncManagerV2", "   Payload final: $payloadWithRoomId")
                    android.util.Log.d("SyncManagerV2", "   ‚úÖ SET executado com sucesso")
                }
                "DELETE" -> {
                    android.util.Log.d("SyncManagerV2", "   Executando DELETE...")
                    docRef.delete().await()
                    android.util.Log.d("SyncManagerV2", "   ‚úÖ DELETE executado com sucesso")
                }
                else -> {
                    android.util.Log.w("SyncManagerV2", "Opera√ß√£o desconhecida: ${operation.operation}")
                    return false
                }
            }
            android.util.Log.d("SyncManagerV2", "‚úÖ Opera√ß√£o ${operation.operation} conclu√≠da com sucesso")
            true
        } catch (e: Exception) {
            android.util.Log.e("SyncManagerV2", "‚ùå Falha no Firestore: ${e.message}", e)
            android.util.Log.e("SyncManagerV2", "   Stack trace: ${e.stackTraceToString()}")
            false
        }
    }

    /**
     * Log de opera√ß√£o de sincroniza√ß√£o
     */
    private suspend fun logSyncOperation(
        entityType: String,
        entityId: Long,
        operation: String,
        status: String,
        errorMessage: String?,
        payload: String?
    ) {
        try {
            val syncLog = SyncLog(
                entityType = entityType,
                entityId = entityId,
                operation = operation,
                syncStatus = status,
                timestamp = Date(),
                errorMessage = errorMessage,
                payload = payload
            )
            
            syncLogDao.inserirSyncLog(syncLog)
        } catch (e: Exception) {
            android.util.Log.w("SyncManagerV2", "Erro ao logar opera√ß√£o: ${e.message}")
        }
    }

    /**
     * Verificar se est√° online
     */
    private fun isOnline(): Boolean {
        val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
        val network = connectivityManager.activeNetwork ?: return false
        val capabilities = connectivityManager.getNetworkCapabilities(network) ?: return false
        
        return capabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||
               capabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR)
    }

    /** Verifica se h√° usu√°rio autenticado no Firebase (regras exigem auth) */
    private fun isAuthenticated(): Boolean {
        return try {
            FirebaseAuth.getInstance().currentUser != null
        } catch (_: Exception) { false }
    }

    /** Obt√©m o ID da empresa para particionar os dados no Firestore */
    private suspend fun getEmpresaId(): String {
        return try {
            val cfg = syncConfigDao.buscarSyncConfigPorChave("empresa_id")
            val empresaId = cfg?.value ?: "empresa_001"
            android.util.Log.d("SyncManagerV2", "üè¢ Empresa ID obtido: $empresaId (config: ${cfg?.key})")
            empresaId
        } catch (e: Exception) { 
            android.util.Log.w("SyncManagerV2", "Erro ao obter empresa_id: ${e.message}, usando padr√£o")
            "empresa_001" 
        }
    }

    /** Mapeia tipos de entidades para cole√ß√µes do Firestore */
    private fun getCollectionName(entityType: String): String = when (entityType.lowercase(Locale.getDefault())) {
        "cliente" -> "clientes"
        "acerto" -> "acertos"
        "mesa" -> "mesas"
        "rota" -> "rotas"
        "colaborador" -> "colaboradores"
        "despesa" -> "despesas"
        "panoestoque" -> "panosEstoque"
        "mesavendida" -> "mesasVendidas"
        "stockitem" -> "stockItems"
        "veiculo" -> "veiculos"
        "historicomanutencaomesa" -> "historicoManutencaoMesa"
        "historicomanutencaoveiculo" -> "historicoManutencaoVeiculo"
        "historicocombustivelveiculo" -> "historicoCombustivelVeiculo"
        "categoriadespesa" -> "categoriasDespesa"
        "tipodespesa" -> "tiposDespesa"
        "contratolocacao" -> "contratosLocacao"
        "contratomesa" -> "contratoMesas"
        "metacolaborador" -> "metas"
        "colaboradorrota" -> "colaboradoresRotas"
        "assinaturarepresentantelegal" -> "assinaturasRepresentanteLegal"
        "logauditoriaassinatura" -> "logsAuditoriaAssinatura"
        "acertomesa" -> "acertoMesa"
        "mesareformada" -> "mesasReformadas"
        "aditivocontrato" -> "aditivosContrato"
        "aditivomesa" -> "aditivoMesas"
        "panomesa" -> "panoMesas"
        "equipment" -> "equipments"
        else -> entityType.lowercase(Locale.getDefault()) + "s"
    }

    /**
     * Iniciar sincroniza√ß√£o peri√≥dica
     */
    private fun startPeriodicSync() {
        syncScope.launch {
            while (isActive) {
                delay(300000) // 5 minutos
                
                if (isOnline() && !isSyncing.get()) {
                    processSyncQueue()
                }
            }
        }
    }

    /**
     * Atualizar timestamp da √∫ltima sincroniza√ß√£o
     */
    private suspend fun updateLastSyncTimestamp() {
        try {
            val currentTime = System.currentTimeMillis()
            syncConfigDao.atualizarUltimoTimestampSync("last_sync_timestamp_global", currentTime.toString(), currentTime)
            _lastSyncTime.postValue(currentTime)
        } catch (e: Exception) {
            android.util.Log.w("SyncManagerV2", "Erro ao atualizar timestamp: ${e.message}")
        }
    }

    /**
     * For√ßar sincroniza√ß√£o manual (PUSH + PULL)
     */
    fun forceSync() {
        syncScope.launch {
            try {
                android.util.Log.d("SyncManagerV2", "üöÄ INICIANDO SINCRONIZA√á√ÉO COMPLETA (PUSH + PULL)")
                
                // 1. PUSH: Enviar dados pendentes para Firestore
                android.util.Log.d("SyncManagerV2", "üì§ Fase 1: PUSH SYNC (App ‚Üí Firestore)")
                processSyncQueue()
                
                // Aguardar um pouco para garantir que PUSH termine
                delay(1000)
                
                // 2. PULL: Baixar dados do Firestore para o app
                android.util.Log.d("SyncManagerV2", "üì• Fase 2: PULL SYNC (Firestore ‚Üí App)")
                pullFromFirestore()
                
                android.util.Log.d("SyncManagerV2", "‚úÖ SINCRONIZA√á√ÉO COMPLETA FINALIZADA")
                
            } catch (e: Exception) {
                android.util.Log.e("SyncManagerV2", "‚ùå Erro na sincroniza√ß√£o completa: ${e.message}", e)
            }
        }
    }

    /**
     * PULL SYNC: Baixar dados do Firestore para o app
     */
    private suspend fun pullFromFirestore() {
        android.util.Log.d("SyncManagerV2", "üîç Verificando condi√ß√µes para PULL SYNC...")
        android.util.Log.d("SyncManagerV2", "   Online: ${isOnline()}")
        android.util.Log.d("SyncManagerV2", "   Autenticado: ${isAuthenticated()}")
        
        if (!isOnline()) {
            android.util.Log.w("SyncManagerV2", "‚ùå PULL SYNC cancelado: Sem conex√£o")
            return
        }
        
        if (!isAuthenticated()) {
            android.util.Log.w("SyncManagerV2", "‚ùå PULL SYNC cancelado: Usu√°rio n√£o autenticado")
            return
        }
        
        try {
            android.util.Log.d("SyncManagerV2", "üîÑ Iniciando PULL SYNC do Firestore")
            
            val empresaId = getEmpresaId()
            android.util.Log.d("SyncManagerV2", "üè¢ Empresa ID para PULL: $empresaId")
            
        // ‚úÖ FASE 12.14: Usar handlers especializados em vez de m√©todos privados
        // 1. PRIMEIRO: Baixar rotas do Firestore (depend√™ncia dos clientes)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 1: Sincronizando ROTAS...")
        rotaPullHandler.pull(empresaId)
        delay(500) // Aguardar rotas serem inseridas

        // 2. SEGUNDO: Baixar clientes do Firestore (dependem das rotas)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 2: Sincronizando CLIENTES...")

        // Verificar se existe pelo menos uma rota antes de sincronizar clientes
        val rotasExistentes = appRepository.obterTodasRotas().first()
        if (rotasExistentes.isEmpty()) {
            android.util.Log.w("SyncManagerV2", "‚ö†Ô∏è Nenhuma rota encontrada no Room. Os clientes precisam de uma rota para serem sincronizados.")
        }
        
        clientePullHandler.pull(empresaId)
        delay(500) // Aguardar clientes serem inseridos

        // 3. TERCEIRO: Baixar mesas do Firestore (dependem dos clientes)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 3: Sincronizando MESAS...")
        mesaPullHandler.pull(empresaId)
        delay(500) // Aguardar mesas serem inseridas

        // 4. QUARTO: Baixar acertos do Firestore (dependem dos clientes)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 4: Sincronizando ACERTOS...")
        acertoPullHandler.pull(empresaId)
        delay(500) // Aguardar acertos serem inseridos

        // 5. QUINTO: Baixar ciclos do Firestore (dependem dos acertos)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 5: Sincronizando CICLOS...")
        cicloPullHandler.pull(empresaId)
        delay(500) // Aguardar ciclos serem inseridos
        
        // 5.1. ATUALIZAR ROTAS: Alinhar status das rotas com os ciclos importados
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 5.1: Atualizando status das rotas com ciclos importados...")
        atualizarRotasComCiclosImportados()
        delay(500) // Aguardar atualiza√ß√µes das rotas
        
        // 6. SEXTO: Baixar colaboradores do Firestore
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 6: Sincronizando COLABORADORES...")
        pullColaboradoresFromFirestore(empresaId)
        delay(500) // Aguardar colaboradores serem inseridos
        
        // 7. S√âTIMO: Baixar despesas do Firestore
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 7: Sincronizando DESPESAS...")
        pullDespesasFromFirestore(empresaId)
        delay(500) // Aguardar despesas serem inseridas
        
        // 8. OITAVO: Baixar panos estoque do Firestore
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 8: Sincronizando PANOS ESTOQUE...")
        pullPanoEstoqueFromFirestore(empresaId)
        delay(500) // Aguardar panos serem inseridos
        
        // 9. NONO: Baixar mesas vendidas do Firestore
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 9: Sincronizando MESAS VENDIDAS...")
        pullMesaVendidaFromFirestore(empresaId)
        delay(500) // Aguardar mesas vendidas serem inseridas
        
        // 10. D√âCIMO: Sincronizar StockItems
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 10: Sincronizando STOCK ITEMS...")
        pullStockItemsFromFirestore(empresaId)
        delay(500) // Aguardar stock items serem inseridos
        
        // 11. D√âCIMO PRIMEIRO: Sincronizar Ve√≠culos
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 11: Sincronizando VE√çCULOS...")
        pullVeiculosFromFirestore(empresaId)
        delay(500) // Aguardar ve√≠culos serem inseridos
        
        // 11.5. D√âCIMO PRIMEIRO E MEIO: Sincronizar Equipamentos
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 11.5: Sincronizando EQUIPAMENTOS...")
        pullEquipmentFromFirestore(empresaId)
        delay(500) // Aguardar equipamentos serem inseridos
        
        // 12. D√âCIMO SEGUNDO: Sincronizar Hist√≥rico Manuten√ß√£o Mesa
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 12: Sincronizando HIST√ìRICO MANUTEN√á√ÉO MESA...")
        pullHistoricoManutencaoMesaFromFirestore(empresaId)
        delay(500) // Aguardar hist√≥rico mesa serem inseridos
        
        // 13. D√âCIMO TERCEIRO: Sincronizar Hist√≥rico Manuten√ß√£o Ve√≠culo
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 13: Sincronizando HIST√ìRICO MANUTEN√á√ÉO VE√çCULO...")
        pullHistoricoManutencaoVeiculoFromFirestore(empresaId)
        delay(500) // Aguardar hist√≥rico ve√≠culo serem inseridos
        
        // 14. D√âCIMO QUARTO: Sincronizar Hist√≥rico Combust√≠vel Ve√≠culo
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 14: Sincronizando HIST√ìRICO COMBUST√çVEL VE√çCULO...")
        pullHistoricoCombustivelVeiculoFromFirestore(empresaId)
        delay(500) // Aguardar hist√≥rico combust√≠vel serem inseridos
        
        // 15. D√âCIMO QUINTO: Sincronizar Categorias Despesa
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 15: Sincronizando CATEGORIAS DESPESA...")
        pullCategoriasDespesaFromFirestore(empresaId)
        delay(500) // Aguardar categorias serem inseridas
        
        // 16. D√âCIMO SEXTO: Sincronizar Tipos Despesa
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 16: Sincronizando TIPOS DESPESA...")
        pullTiposDespesaFromFirestore(empresaId)
        delay(500) // Aguardar tipos serem inseridos
        
        // 17. D√âCIMO S√âTIMO: Sincronizar Contratos Loca√ß√£o
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17: Sincronizando CONTRATOS LOCA√á√ÉO...")
        pullContratosLocacaoFromFirestore(empresaId)
        delay(500) // Aguardar contratos serem inseridos
        
        // 17.0.1: Sincronizar Metas (dependem de colaboradores/rotas e opcionalmente ciclo)
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17.0.1: Sincronizando METAS...")
        pullMetasFromFirestore(empresaId)
        delay(300)

        // 17.0.2: Sincronizar ColaboradorRota
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17.0.2: Sincronizando COLABORADOR_ROTA...")
        pullColaboradoresRotasFromFirestore(empresaId)
        delay(300)

        // 17.1: Sincronizar Aditivos de Contrato
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17.1: Sincronizando ADITIVOS DE CONTRATO...")
        pullAditivosContratoFromFirestore(empresaId)
        delay(300)
        
        // 17.2: Sincronizar Aditivo Mesas
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17.2: Sincronizando ADITIVO MESAS...")
        pullAditivoMesasFromFirestore(empresaId)
        delay(300)

        // 17.3: Sincronizar Contrato Mesas
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 17.3: Sincronizando CONTRATO MESAS...")
        pullContratoMesasFromFirestore(empresaId)
        delay(300)
        
        // 18. D√âCIMO OITAVO: Sincronizar Assinaturas Representante Legal
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 18: Sincronizando ASSINATURAS REPRESENTANTE LEGAL...")
        pullAssinaturasRepresentanteLegalFromFirestore(empresaId)
        delay(500) // Aguardar assinaturas serem inseridas
        
        // 19. D√âCIMO NONO: Sincronizar Logs Auditoria Assinatura
        android.util.Log.d("SyncManagerV2", "üîÑ Fase 19: Sincronizando LOGS AUDITORIA ASSINATURA...")
        pullLogsAuditoriaAssinaturaFromFirestore(empresaId)
        delay(500) // Aguardar logs serem inseridos
        
        // 20. VIG√âSIMO: Sincronizar AcertoMesa
        android.util.Log.