# 2. ARQUITETURA T√âCNICA (Android 2025)

## üèóÔ∏è PADR√ïES DE DESENVOLVIMENTO

### **Stack Tecnol√≥gico (Modernizado 2025)**

- **Kotlin**: Linguagem principal (100%)
- **Jetpack Compose**: UI moderna (35.8% implementado)
- **Material Design 3**: Tema e componentes modernos
- **Android Architecture Components**: ViewModel, StateFlow, Room
- **Navigation Component**: Navega√ß√£o type-safe
- **Room Database**: Persist√™ncia local offline-first
- **StateFlow**: Observa√ß√£o reativa moderna (substitui LiveData)
- **WorkManager**: Background tasks (sincroniza√ß√£o)
- **Firebase Firestore**: Backend (configurado, aguardando SyncManagerV2)
- **RepositoryFactory**: Inje√ß√£o de depend√™ncia simples (Hilt pode ser adicionado futuramente)

### **Arquitetura MVVM Modernizada (H√≠brida)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    UI LAYER                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Compose    ‚îÇ  ‚îÇ   Fragments  ‚îÇ  ‚îÇ   Activities ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Screens    ‚îÇ  ‚îÇ   (Legacy)   ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ         ‚îÇ                 ‚îÇ                  ‚îÇ          ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                           ‚îÇ                             ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ                    ‚îÇ  ViewModels ‚îÇ                      ‚îÇ
‚îÇ                    ‚îÇ  (StateFlow)‚îÇ                      ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    DOMAIN LAYER                          ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ                    ‚îÇ AppRepository‚îÇ                      ‚îÇ
‚îÇ                    ‚îÇ   (Facade)   ‚îÇ                      ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                           ‚îÇ                             ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ         ‚îÇ                 ‚îÇ                 ‚îÇ           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ   Client    ‚îÇ  ‚îÇ   Acerto    ‚îÇ  ‚îÇ    Mesa     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Repository  ‚îÇ  ‚îÇ Repository  ‚îÇ  ‚îÇ Repository  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ    Rota     ‚îÇ  ‚îÇ  Despesa    ‚îÇ  ‚îÇ Colaborador ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Repository  ‚îÇ  ‚îÇ Repository  ‚îÇ  ‚îÇ Repository  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ  ‚îÇ  Contrato   ‚îÇ  ‚îÇ    Ciclo    ‚îÇ                      ‚îÇ
‚îÇ  ‚îÇ Repository  ‚îÇ  ‚îÇ Repository  ‚îÇ                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    DATA LAYER                            ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ                    ‚îÇ     DAOs    ‚îÇ                      ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                           ‚îÇ                             ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ                    ‚îÇ Room Database‚îÇ                     ‚îÇ
‚îÇ                    ‚îÇ  (Local SQL) ‚îÇ                     ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Arquitetura H√≠brida Modular (2025)**

**Princ√≠pio**: AppRepository como Facade centralizado + Repositories especializados por dom√≠nio

**Benef√≠cios**:
- ‚úÖ Trabalho paralelo sem conflitos (4+ agents)
- ‚úÖ C√≥digo organizado por dom√≠nio
- ‚úÖ Compatibilidade preservada (ViewModels n√£o mudam)
- ‚úÖ Performance otimizada (cache centralizado)
- ‚úÖ Escalabilidade (f√°cil adicionar novos dom√≠nios)

## üóÑÔ∏è BANCO DE DADOS

### **Room Database (Offline-first)**

**Entidades Principais**:
- `Cliente`: Dados dos clientes
- `Mesa`: Mesas de bilhar dispon√≠veis
- `Rota`: Rotas de entrega
- `Acerto`: Transa√ß√µes de acerto
- `Despesa`: Despesas por rota/ciclo
- `CicloAcerto`: Ciclos de acerto
- `ContratoLocacao`: Contratos de loca√ß√£o
- `Colaborador`: Colaboradores do sistema
- `SignaturePoint`: Pontos de assinatura

**Relacionamentos**:
- Cliente ‚Üí Mesa (1:N)
- Rota ‚Üí Cliente (1:N)
- Cliente ‚Üí Acerto (1:N)
- Contrato ‚Üí Mesa (1:N)
- Ciclo ‚Üí Acerto (1:N)

## üì± COMPONENTES UI

### **Jetpack Compose (35.8% implementado)**

**Telas Compose Implementadas**:
- `RoutesScreen`, `DashboardScreen`, `ClientListScreen`, `ClientDetailScreen`
- `SettlementScreen`, `SettlementDetailScreen`, `ClosureReportScreen`
- `VehiclesScreen`, `VehicleDetailScreen`, `StockScreen`
- `ContractManagementScreen`, `SignatureCaptureScreen`
- `MetasScreen`, `ColaboradoresScreen`, `CiclosScreen`
- `ExpenseRegisterScreen`, `MesasDepositoScreen`, `NovaReformaScreen`
- `LoginScreen`

**Fragments Legacy (64.2% pendente)**:
- `SettlementFragment`, `ClientListFragment`, `CycleManagementFragment`
- `ExpenseHistoryFragment`, `GerenciarMesasFragment`
- E mais 38 telas...

### **Padr√£o StateFlow**

```kotlin
// ‚úÖ CORRETO: Observa√ß√£o moderna com repeatOnLifecycle
viewLifecycleOwner.lifecycleScope.launch {
    viewLifecycleOwner.repeatOnLifecycle(Lifecycle.State.STARTED) {
        viewModel.property.collect { value ->
            // Atualizar UI
        }
    }
}
```

## üîê SEGURAN√áA E VALIDA√á√ÉO

### **Assinatura Eletr√¥nica (Lei 14.063/2020)**

- **SignatureView**: Captura de assinatura manual
- **SignatureStatistics**: Valida√ß√£o biom√©trica
- **DocumentIntegrityManager**: Hash SHA-256
- **LegalLogger**: Logs jur√≠dicos para auditoria
- **SignatureMetadataCollector**: Metadados do dispositivo

**Valida√ß√µes**:
- Captura de metadados (timestamp, device ID, IP, press√£o, velocidade)
- Gera√ß√£o de hash SHA-256 para integridade
- Logs jur√≠dicos completos para auditoria
- Valida√ß√£o de caracter√≠sticas biom√©tricas
- Confirma√ß√£o de presen√ßa f√≠sica do locat√°rio

## üîÑ SINCRONIZA√á√ÉO (PENDENTE)

### **Estrat√©gia Offline-first**

1. **Dados Locais**: Sempre dispon√≠veis (Room Database)
2. **Fila de Sincroniza√ß√£o**: Opera√ß√µes offline enfileiradas
3. **Sincroniza√ß√£o Bidirecional**: Pull (servidor ‚Üí local) + Push (local ‚Üí servidor)
4. **Resolu√ß√£o de Conflitos**: √öltima escrita vence (pode ser melhorado)
5. **WorkManager**: Sincroniza√ß√£o peri√≥dica em background

### **Implementa√ß√£o Futura**

```kotlin
// Estrutura proposta para SyncManagerV2
class SyncRepository(
    private val appRepository: AppRepository,
    private val firestore: FirebaseFirestore
) {
    suspend fun syncPull() // Sincronizar do servidor
    suspend fun syncPush() // Enviar para servidor
    suspend fun syncBidirectional() // Sincroniza√ß√£o completa
}
```

## üéØ MELHORES PR√ÅTICAS ANDROID 2025

1. **Jetpack Compose**: Priorizar para novas telas
2. **StateFlow**: Usar em vez de LiveData
3. **repeatOnLifecycle**: Observa√ß√£o segura de StateFlow
4. **Offline-first**: Dados sempre dispon√≠veis localmente
5. **Modulariza√ß√£o**: C√≥digo organizado por dom√≠nio
6. **Type-safe Navigation**: Navigation Component
7. **Material Design 3**: Componentes modernos
8. **WorkManager**: Background tasks confi√°veis

## üìö REFER√äNCIAS

- [Android Developer - Architecture](https://developer.android.com/topic/architecture)
- [Jetpack Compose](https://developer.android.com/jetpack/compose)
- [StateFlow vs LiveData](https://developer.android.com/kotlin/flow/stateflow-and-sharedflow)
- [WorkManager](https://developer.android.com/topic/libraries/architecture/workmanager)
- [Firebase Firestore](https://firebase.google.com/docs/firestore)
