<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainActivity.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.example.gestaobilhares</a> &gt; <span class="el_source">MainActivity.kt</span></div><h1>MainActivity.kt</h1><pre class="source lang-java linenums">Ôªøpackage com.example.gestaobilhares

import android.content.pm.PackageManager
import android.os.Bundle
import android.util.Log
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.navigation.fragment.NavHostFragment
import androidx.activity.OnBackPressedCallback
import androidx.lifecycle.lifecycleScope
import com.example.gestaobilhares.ui.databinding.ActivityMainBinding
import com.example.gestaobilhares.core.utils.NetworkUtils
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import kotlinx.coroutines.launch
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
// ‚úÖ REMOVIDO: import DatabasePopulator - n√£o √© mais necess√°rio
// import dagger.hilt.android.AndroidEntryPoint // REMOVIDO: Hilt nao e mais usado
// ‚úÖ REMOVIDO: imports CoroutineScope - n√£o s√£o mais necess√°rios
/**
 * MainActivity configurada para Navigation Component e ViewBinding.
 * Usando NoActionBar theme - navega√ß√£o gerenciada pelos pr√≥prios fragments.
 */
<span class="nc" id="L24">class MainActivity : AppCompatActivity() {</span>
    private lateinit var binding: ActivityMainBinding
    private var isSyncingOnExit = false

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L29">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L30">        binding = ActivityMainBinding.inflate(layoutInflater)</span>
<span class="nc" id="L31">        setContentView(binding.root)</span>

        // Navigation Controller configurado automaticamente - gerenciado pelos fragments
        // REMOVIDO: setupActionBarWithNavController() - incompat√≠vel com NoActionBar theme

        // ‚úÖ REMOVIDO: Popular banco de dados - agora √© feito automaticamente no AppDatabase
        // popularBancoDados()
        
        // ‚úÖ CORRE√á√ÉO: Gerenciar bot√£o voltar globalmente
        // Mostra di√°logo de sa√≠da apenas na tela de rotas, caso contr√°rio deixa Navigation Component gerenciar
<span class="nc" id="L41">        onBackPressedDispatcher.addCallback(this, object : OnBackPressedCallback(true) {</span>
            override fun handleOnBackPressed() {
<span class="nc bnc" id="L43" title="All 4 branches missed.">                val navHostFragment = supportFragmentManager.findFragmentById(</span>
<span class="nc" id="L44">                    com.example.gestaobilhares.ui.R.id.nav_host_fragment</span>
<span class="nc" id="L45">                ) as? NavHostFragment ?: run {</span>
<span class="nc" id="L46">                    finish()</span>
<span class="nc" id="L47">                    return</span>
                }
<span class="nc" id="L49">                val navController = navHostFragment.navController</span>
                
                // ‚úÖ Verificar se estamos na tela de rotas
                // Se o destino atual √© routesFragment, mostrar di√°logo de sa√≠da
                // Caso contr√°rio, deixar Navigation Component gerenciar o comportamento padr√£o
<span class="nc bnc" id="L54" title="All 2 branches missed.">                val currentDestinationId = navController.currentDestination?.id</span>
<span class="nc bnc" id="L55" title="All 4 branches missed.">                val isRoutesScreen = currentDestinationId == com.example.gestaobilhares.ui.R.id.routesFragment</span>
                
<span class="nc bnc" id="L57" title="All 2 branches missed.">                if (isRoutesScreen) {</span>
                    // Estamos na tela de rotas - mostrar di√°logo de sa√≠da
<span class="nc" id="L59">                    showExitConfirmationDialog()</span>
                } else {
                    // N√£o estamos na tela de rotas - voltar para tela anterior
                    // ‚úÖ CORRIGIDO: Usar popBackStack() em vez de navigateUp()
<span class="nc bnc" id="L63" title="All 2 branches missed.">                    if (!navController.popBackStack()) {</span>
                        // Se n√£o conseguiu voltar (n√£o h√° mais telas no back stack), fechar o app
<span class="nc" id="L65">                        finish()</span>
                    }
                }
<span class="nc" id="L68">            }</span>
        })
<span class="nc" id="L70">    }</span>
    
    /**
     * ‚úÖ NOVO: Mostra di√°logo de confirma√ß√£o para sair do app
     */
    private fun showExitConfirmationDialog() {
<span class="nc" id="L76">        MaterialAlertDialogBuilder(this)</span>
<span class="nc" id="L77">            .setTitle(&quot;Sair do aplicativo&quot;)</span>
<span class="nc" id="L78">            .setMessage(&quot;Deseja realmente sair do aplicativo?&quot;)</span>
<span class="nc" id="L79">            .setPositiveButton(&quot;Sair&quot;) { _, _ -&gt;</span>
                // Verificar sincroniza√ß√£o antes de fechar
<span class="nc" id="L81">                checkPendingSyncBeforeExit()</span>
<span class="nc" id="L82">            }</span>
<span class="nc" id="L83">            .setNegativeButton(&quot;Cancelar&quot;) { dialog, _ -&gt;</span>
<span class="nc" id="L84">                dialog.dismiss()</span>
<span class="nc" id="L85">            }</span>
<span class="nc" id="L86">            .setCancelable(true)</span>
<span class="nc" id="L87">            .show()</span>
<span class="nc" id="L88">    }</span>
    
    /**
     * ‚úÖ NOVO: Verifica se h√° dados pendentes de sincroniza√ß√£o antes de fechar o app
     */
    private fun checkPendingSyncBeforeExit() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (isSyncingOnExit) {</span>
            // J√° est√° sincronizando, n√£o fazer nada
<span class="nc" id="L96">            return</span>
        }
        
<span class="nc" id="L99">        lifecycleScope.launch {</span>
<span class="nc" id="L100">            try {</span>
<span class="nc" id="L101">                val appRepository = com.example.gestaobilhares.factory.RepositoryFactory.getAppRepository(this@MainActivity)</span>
<span class="nc" id="L102">                val networkUtils = NetworkUtils(this@MainActivity)</span>
                
                // Verificar se est√° online
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (!networkUtils.isConnected()) {</span>
<span class="nc" id="L106">                    Log.d(&quot;MainActivity&quot;, &quot;App offline - fechando sem verificar sincroniza√ß√£o&quot;)</span>
<span class="nc" id="L107">                    finish()</span>
<span class="nc" id="L108">                    return@launch</span>
                }
                
                // Verificar pend√™ncias de sincroniza√ß√£o
<span class="nc" id="L112">                val pending = withContext(Dispatchers.IO) {</span>
<span class="nc" id="L113">                    appRepository.contarOperacoesSyncPendentes()</span>
                }
                
<span class="nc" id="L116">                Log.d(&quot;MainActivity&quot;, &quot;üì° Pend√™ncias de sincroniza√ß√£o ao fechar: $pending&quot;)</span>
                
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (pending &gt; 0) {</span>
                    // Mostrar di√°logo perguntando se deseja sincronizar
<span class="nc" id="L120">                    MaterialAlertDialogBuilder(this@MainActivity)</span>
<span class="nc" id="L121">                        .setTitle(&quot;Sincroniza√ß√£o pendente&quot;)</span>
<span class="nc" id="L122">                        .setMessage(&quot;Voc√™ tem $pending opera√ß√£o(√µes) pendente(s) de sincroniza√ß√£o.\n\nDeseja sincronizar antes de fechar o app?&quot;)</span>
<span class="nc" id="L123">                        .setPositiveButton(&quot;Sincronizar&quot;) { _, _ -&gt;</span>
<span class="nc" id="L124">                            performSyncBeforeExit()</span>
<span class="nc" id="L125">                        }</span>
<span class="nc" id="L126">                        .setNegativeButton(&quot;Fechar mesmo assim&quot;) { _, _ -&gt;</span>
<span class="nc" id="L127">                            finish()</span>
<span class="nc" id="L128">                        }</span>
<span class="nc" id="L129">                        .setCancelable(false)</span>
<span class="nc" id="L130">                        .show()</span>
                } else {
                    // Sem pend√™ncias, fechar normalmente
<span class="nc" id="L133">                    finish()</span>
                }
<span class="nc" id="L135">            } catch (e: Exception) {</span>
<span class="nc" id="L136">                Log.e(&quot;MainActivity&quot;, &quot;Erro ao verificar pend√™ncias: ${e.message}&quot;, e)</span>
                // Em caso de erro, fechar normalmente
<span class="nc" id="L138">                finish()</span>
            }
<span class="nc" id="L140">        }</span>
<span class="nc" id="L141">    }</span>
    
    /**
     * ‚úÖ NOVO: Executa sincroniza√ß√£o antes de fechar o app
     */
    private fun performSyncBeforeExit() {
<span class="nc" id="L147">        isSyncingOnExit = true</span>
        
<span class="nc" id="L149">        lifecycleScope.launch {</span>
<span class="nc" id="L150">            try {</span>
                // Criar SyncRepository diretamente (sem usar RepositoryFactory para evitar depend√™ncia circular)
<span class="nc" id="L152">                val database = com.example.gestaobilhares.data.database.AppDatabase.getDatabase(this@MainActivity)</span>
<span class="nc" id="L153">                val appRepository = com.example.gestaobilhares.data.repository.AppRepository.create(database)</span>
<span class="nc" id="L154">                val syncRepository = com.example.gestaobilhares.sync.SyncRepository(this@MainActivity, appRepository)</span>
                
                // Mostrar di√°logo de progresso
<span class="nc" id="L157">                val progressView = layoutInflater.inflate(com.example.gestaobilhares.ui.R.layout.dialog_sync_progress, null)</span>
<span class="nc" id="L158">                val progressBar = progressView.findViewById&lt;android.widget.ProgressBar&gt;(com.example.gestaobilhares.ui.R.id.syncProgressBar)</span>
<span class="nc" id="L159">                val progressPercent = progressView.findViewById&lt;android.widget.TextView&gt;(com.example.gestaobilhares.ui.R.id.tvSyncProgressPercent)</span>
<span class="nc" id="L160">                val progressStatus = progressView.findViewById&lt;android.widget.TextView&gt;(com.example.gestaobilhares.ui.R.id.tvSyncProgressStatus)</span>
                
<span class="nc" id="L162">                progressBar.progress = 0</span>
<span class="nc" id="L163">                progressPercent.text = &quot;0%&quot;</span>
<span class="nc" id="L164">                progressStatus.text = getString(com.example.gestaobilhares.ui.R.string.sync_status_preparing)</span>
                
<span class="nc" id="L166">                val progressDialog = MaterialAlertDialogBuilder(this@MainActivity)</span>
<span class="nc" id="L167">                    .setTitle(com.example.gestaobilhares.ui.R.string.sync_progress_title)</span>
<span class="nc" id="L168">                    .setView(progressView)</span>
<span class="nc" id="L169">                    .setCancelable(false)</span>
<span class="nc" id="L170">                    .create()</span>
<span class="nc" id="L171">                progressDialog.show()</span>
                
                // Executar sincroniza√ß√£o
<span class="nc" id="L174">                val result = withContext(Dispatchers.IO) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                    syncRepository.syncBidirectional { progress -&gt;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                        lifecycleScope.launch {</span>
<span class="nc" id="L177">                            progressBar.progress = progress.percent</span>
<span class="nc" id="L178">                            progressPercent.text = &quot;${progress.percent}%&quot;</span>
<span class="nc" id="L179">                            progressStatus.text = progress.message</span>
<span class="nc" id="L180">                        }</span>
<span class="nc" id="L181">                    }</span>
                }
                
<span class="nc" id="L184">                progressDialog.dismiss()</span>
                
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (result.isSuccess) {</span>
<span class="nc" id="L187">                    android.widget.Toast.makeText(</span>
<span class="nc" id="L188">                        this@MainActivity,</span>
<span class="nc" id="L189">                        &quot;‚úÖ Sincroniza√ß√£o conclu√≠da!&quot;,</span>
<span class="nc" id="L190">                        android.widget.Toast.LENGTH_SHORT</span>
<span class="nc" id="L191">                    ).show()</span>
                } else {
<span class="nc" id="L193">                    android.widget.Toast.makeText(</span>
<span class="nc" id="L194">                        this@MainActivity,</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                        &quot;‚ö†Ô∏è Sincroniza√ß√£o falhou: ${result.exceptionOrNull()?.message}&quot;,</span>
<span class="nc" id="L196">                        android.widget.Toast.LENGTH_LONG</span>
<span class="nc" id="L197">                    ).show()</span>
                }
                
                // Fechar app ap√≥s sincroniza√ß√£o
<span class="nc" id="L201">                finish()</span>
<span class="nc" id="L202">            } catch (e: Exception) {</span>
<span class="nc" id="L203">                Log.e(&quot;MainActivity&quot;, &quot;Erro na sincroniza√ß√£o: ${e.message}&quot;, e)</span>
<span class="nc" id="L204">                android.widget.Toast.makeText(</span>
<span class="nc" id="L205">                    this@MainActivity,</span>
<span class="nc" id="L206">                    &quot;‚ùå Erro na sincroniza√ß√£o: ${e.message}&quot;,</span>
<span class="nc" id="L207">                    android.widget.Toast.LENGTH_LONG</span>
<span class="nc" id="L208">                ).show()</span>
<span class="nc" id="L209">                finish()</span>
            } finally {
<span class="nc" id="L211">                isSyncingOnExit = false</span>
            }
<span class="nc" id="L213">        }</span>
<span class="nc" id="L214">    }</span>

    // ‚úÖ REMOVIDO: Fun√ß√£o popularBancoDados() - agora √© feita automaticamente no AppDatabase

    override fun onSupportNavigateUp(): Boolean {
<span class="nc" id="L219">        val navHostFragment = supportFragmentManager</span>
<span class="nc" id="L220">            .findFragmentById(com.example.gestaobilhares.ui.R.id.nav_host_fragment) as NavHostFragment</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">        return navHostFragment.navController.navigateUp() || super.onSupportNavigateUp()</span>
    }

    /**
     * ‚úÖ NOVO: Tratamento de permiss√µes Bluetooth para impress√£o
     */
    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array&lt;out String&gt;,
        grantResults: IntArray
    ) {
<span class="nc" id="L232">        super.onRequestPermissionsResult(requestCode, permissions, grantResults)</span>
        
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (requestCode == 1001) { // REQUEST_BLUETOOTH_PERMISSIONS</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">            if (grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {</span>
                // Permiss√µes concedidas - notificar que pode tentar imprimir novamente
<span class="nc" id="L237">                Log.d(&quot;MainActivity&quot;, &quot;Permiss√µes Bluetooth concedidas&quot;)</span>
                // O usu√°rio pode tentar imprimir novamente
            } else {
<span class="nc" id="L240">                Log.w(&quot;MainActivity&quot;, &quot;Permiss√µes Bluetooth negadas&quot;)</span>
                // Mostrar mensagem explicativa
<span class="nc" id="L242">                androidx.appcompat.app.AlertDialog.Builder(this)</span>
<span class="nc" id="L243">                    .setTitle(&quot;üîó Permiss√µes Bluetooth Negadas&quot;)</span>
<span class="nc" id="L244">                    .setMessage(&quot;Para imprimir recibos, √© necess√°rio permitir o acesso ao Bluetooth. V√° em Configura√ß√µes &gt; Aplicativos &gt; Gest√£o Bilhares &gt; Permiss√µes e ative o Bluetooth.&quot;)</span>
<span class="nc" id="L245">                    .setPositiveButton(&quot;Entendi&quot;, null)</span>
<span class="nc" id="L246">                    .show()</span>
            }
        }
<span class="nc" id="L249">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>