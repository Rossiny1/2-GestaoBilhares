<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.example.gestaobilhares.notification</a> &gt; <span class="el_source">NotificationService.kt</span></div><h1>NotificationService.kt</h1><pre class="source lang-java linenums">﻿package com.example.gestaobilhares.notification

import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.os.Build
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.example.gestaobilhares.ui.R
import com.example.gestaobilhares.MainActivity

<span class="nc" id="L15">class NotificationService(private val context: Context) {</span>

    companion object {
        const val CHANNEL_ID_APPROVALS = &quot;approvals_channel&quot;
        const val CHANNEL_ID_ALERTS = &quot;alerts_channel&quot;
        const val CHANNEL_ID_GENERAL = &quot;general_channel&quot;
        
        const val NOTIFICATION_ID_APPROVAL = 1001
        const val NOTIFICATION_ID_META_ALERT = 1002
        const val NOTIFICATION_ID_GENERAL = 1003
    }

<span class="nc" id="L27">    init {</span>
<span class="nc" id="L28">        createNotificationChannels()</span>
<span class="nc" id="L29">    }</span>

    private fun createNotificationChannels() {
<span class="nc bnc" id="L32" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {</span>
<span class="nc" id="L33">            val approvalChannel = NotificationChannel(</span>
<span class="nc" id="L34">                CHANNEL_ID_APPROVALS,</span>
<span class="nc" id="L35">                &quot;Aprovações&quot;,</span>
<span class="nc" id="L36">                NotificationManager.IMPORTANCE_HIGH</span>
<span class="nc" id="L37">            ).apply {</span>
<span class="nc" id="L38">                description = &quot;Notificações de aprovação de colaboradores&quot;</span>
<span class="nc" id="L39">                enableVibration(true)</span>
<span class="nc" id="L40">                enableLights(true)</span>
<span class="nc" id="L41">            }</span>

<span class="nc" id="L43">            val alertChannel = NotificationChannel(</span>
<span class="nc" id="L44">                CHANNEL_ID_ALERTS,</span>
<span class="nc" id="L45">                &quot;Alertas&quot;,</span>
<span class="nc" id="L46">                NotificationManager.IMPORTANCE_DEFAULT</span>
<span class="nc" id="L47">            ).apply {</span>
<span class="nc" id="L48">                description = &quot;Alertas de metas e performance&quot;</span>
<span class="nc" id="L49">                enableVibration(true)</span>
<span class="nc" id="L50">            }</span>

<span class="nc" id="L52">            val generalChannel = NotificationChannel(</span>
<span class="nc" id="L53">                CHANNEL_ID_GENERAL,</span>
<span class="nc" id="L54">                &quot;Geral&quot;,</span>
<span class="nc" id="L55">                NotificationManager.IMPORTANCE_LOW</span>
<span class="nc" id="L56">            ).apply {</span>
<span class="nc" id="L57">                description = &quot;Notificações gerais do sistema&quot;</span>
<span class="nc" id="L58">            }</span>

<span class="nc" id="L60">            val notificationManager = context.getSystemService(NotificationManager::class.java)</span>
<span class="nc" id="L61">            notificationManager.createNotificationChannels(listOf(approvalChannel, alertChannel, generalChannel))</span>
        }
<span class="nc" id="L63">    }</span>

    fun showApprovalNotification(colaboradorNome: String, colaboradorId: Long) {
<span class="nc" id="L66">        val intent = Intent(context, MainActivity::class.java).apply {</span>
<span class="nc" id="L67">            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK</span>
<span class="nc" id="L68">            putExtra(&quot;fragment&quot;, &quot;colaborador_management&quot;)</span>
<span class="nc" id="L69">            putExtra(&quot;colaborador_id&quot;, colaboradorId)</span>
<span class="nc" id="L70">        }</span>

<span class="nc" id="L72">        val pendingIntent = PendingIntent.getActivity(</span>
<span class="nc" id="L73">            context,</span>
<span class="nc" id="L74">            0,</span>
<span class="nc" id="L75">            intent,</span>
<span class="nc" id="L76">            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE</span>
        )

<span class="nc" id="L79">        val notification = NotificationCompat.Builder(context, CHANNEL_ID_APPROVALS)</span>
<span class="nc" id="L80">            .setSmallIcon(R.drawable.ic_person)</span>
<span class="nc" id="L81">            .setContentTitle(&quot;Novo Colaborador Aguardando Aprovação&quot;)</span>
<span class="nc" id="L82">            .setContentText(&quot;$colaboradorNome solicitou acesso ao sistema&quot;)</span>
<span class="nc" id="L83">            .setPriority(NotificationCompat.PRIORITY_HIGH)</span>
<span class="nc" id="L84">            .setAutoCancel(true)</span>
<span class="nc" id="L85">            .setContentIntent(pendingIntent)</span>
<span class="nc" id="L86">            .addAction(</span>
<span class="nc" id="L87">                R.drawable.ic_check,</span>
<span class="nc" id="L88">                &quot;Aprovar&quot;,</span>
<span class="nc" id="L89">                createApprovalAction(colaboradorId, true)</span>
            )
<span class="nc" id="L91">            .addAction(</span>
<span class="nc" id="L92">                R.drawable.ic_close,</span>
<span class="nc" id="L93">                &quot;Rejeitar&quot;,</span>
<span class="nc" id="L94">                createApprovalAction(colaboradorId, false)</span>
            )
<span class="nc" id="L96">            .build()</span>

<span class="nc" id="L98">        NotificationManagerCompat.from(context).notify(NOTIFICATION_ID_APPROVAL, notification)</span>
<span class="nc" id="L99">    }</span>

    fun showMetaAlertNotification(metaDescricao: String, valorAtual: Double, valorMeta: Double) {
<span class="nc" id="L102">        val intent = Intent(context, MainActivity::class.java).apply {</span>
<span class="nc" id="L103">            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK</span>
<span class="nc" id="L104">            putExtra(&quot;fragment&quot;, &quot;reports&quot;)</span>
<span class="nc" id="L105">        }</span>

<span class="nc" id="L107">        val pendingIntent = PendingIntent.getActivity(</span>
<span class="nc" id="L108">            context,</span>
<span class="nc" id="L109">            0,</span>
<span class="nc" id="L110">            intent,</span>
<span class="nc" id="L111">            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE</span>
        )

<span class="nc" id="L114">        val percentual = (valorAtual / valorMeta) * 100</span>
<span class="nc" id="L115">        val notification = NotificationCompat.Builder(context, CHANNEL_ID_ALERTS)</span>
<span class="nc" id="L116">            .setSmallIcon(R.drawable.ic_warning)</span>
<span class="nc" id="L117">            .setContentTitle(&quot;Alerta de Meta&quot;)</span>
<span class="nc" id="L118">            .setContentText(&quot;Meta '$metaDescricao': ${String.format(&quot;%.1f&quot;, percentual)}% atingida&quot;)</span>
<span class="nc" id="L119">            .setPriority(NotificationCompat.PRIORITY_DEFAULT)</span>
<span class="nc" id="L120">            .setAutoCancel(true)</span>
<span class="nc" id="L121">            .setContentIntent(pendingIntent)</span>
<span class="nc" id="L122">            .build()</span>

<span class="nc" id="L124">        NotificationManagerCompat.from(context).notify(NOTIFICATION_ID_META_ALERT, notification)</span>
<span class="nc" id="L125">    }</span>

    fun showGeneralNotification(titulo: String, mensagem: String) {
<span class="nc" id="L128">        val intent = Intent(context, MainActivity::class.java).apply {</span>
<span class="nc" id="L129">            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK</span>
<span class="nc" id="L130">        }</span>

<span class="nc" id="L132">        val pendingIntent = PendingIntent.getActivity(</span>
<span class="nc" id="L133">            context,</span>
<span class="nc" id="L134">            0,</span>
<span class="nc" id="L135">            intent,</span>
<span class="nc" id="L136">            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE</span>
        )

<span class="nc" id="L139">        val notification = NotificationCompat.Builder(context, CHANNEL_ID_GENERAL)</span>
<span class="nc" id="L140">            .setSmallIcon(R.drawable.ic_info)</span>
<span class="nc" id="L141">            .setContentTitle(titulo)</span>
<span class="nc" id="L142">            .setContentText(mensagem)</span>
<span class="nc" id="L143">            .setPriority(NotificationCompat.PRIORITY_LOW)</span>
<span class="nc" id="L144">            .setAutoCancel(true)</span>
<span class="nc" id="L145">            .setContentIntent(pendingIntent)</span>
<span class="nc" id="L146">            .build()</span>

<span class="nc" id="L148">        NotificationManagerCompat.from(context).notify(NOTIFICATION_ID_GENERAL, notification)</span>
<span class="nc" id="L149">    }</span>

    private fun createApprovalAction(colaboradorId: Long, aprovado: Boolean): PendingIntent {
        // TODO: Implementar NotificationActionReceiver
<span class="nc" id="L153">        val intent = Intent(context, MainActivity::class.java).apply {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            action = if (aprovado) &quot;APPROVE_COLABORADOR&quot; else &quot;REJECT_COLABORADOR&quot;</span>
<span class="nc" id="L155">            putExtra(&quot;colaborador_id&quot;, colaboradorId)</span>
<span class="nc" id="L156">        }</span>

<span class="nc" id="L158">        return PendingIntent.getActivity(</span>
<span class="nc" id="L159">            context,</span>
<span class="nc" id="L160">            colaboradorId.toInt(),</span>
<span class="nc" id="L161">            intent,</span>
<span class="nc" id="L162">            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE</span>
        )
    }

    fun cancelNotification(notificationId: Int) {
<span class="nc" id="L167">        NotificationManagerCompat.from(context).cancel(notificationId)</span>
<span class="nc" id="L168">    }</span>

    fun cancelAllNotifications() {
<span class="nc" id="L171">        NotificationManagerCompat.from(context).cancelAll()</span>
<span class="nc" id="L172">    }</span>
}

// BroadcastReceiver para lidar com ações de notificação
<span class="nc" id="L176">class NotificationActionReceiver : BroadcastReceiver() {</span>
    override fun onReceive(context: Context?, intent: Intent?) {
        // Implementação futura para lidar com ações de notificação
        // Por enquanto, apenas um stub para resolver o erro de compilação
<span class="nc bnc" id="L180" title="All 2 branches missed.">        android.util.Log.d(&quot;NotificationActionReceiver&quot;, &quot;Ação recebida: ${intent?.action}&quot;)</span>
<span class="nc" id="L181">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>