rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // üîê FUN√á√ïES AUXILIARES (SECURITY HELPERS)
    // =================================================================

    // Verifica se √© administrador global via Custom Claims
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.role == 'admin' || request.auth.token.admin == true);
    }

    // Verifica se o usu√°rio pertence √† empresa especificada
    function belongsToCompany(empresaId) {
      return request.auth != null && 
             request.auth.token.companyId == empresaId;
    }

    // Verifica se √© admin DA EMPRESA
    function isCompanyAdmin(empresaId) {
       return belongsToCompany(empresaId) && 
              (request.auth.token.role == 'manager' || request.auth.token.role == 'admin');
    }

    // =================================================================
    // üö´ COLE√á√ïES BLOQUEADAS (Apenas Admin Global)
    // =================================================================
    
    match /logsAuditoria/{logId} { allow read, write: if isAdmin(); }
    match /historicoManutencaoMesa/{item} { allow read, write: if isAdmin(); }
    match /historicoManutencaoVeiculo/{item} { allow read, write: if isAdmin(); }
    match /historicoCombustivelVeiculo/{item} { allow read, write: if isAdmin(); }
    match /equipamentos/{item} { allow read, write: if isAdmin(); }
    match /panoEstoque/{item} { allow read, write: if isAdmin(); }
    match /panoMesa/{item} { allow read, write: if isAdmin(); }
    match /stockItem/{item} { allow read, write: if isAdmin(); }
    match /veiculos/{item} { allow read, write: if isAdmin(); }
    match /mesaVendida/{item} { allow read, write: if isAdmin(); }
    match /mesaReformada/{item} { allow read, write: if isAdmin(); }
    match /contratos/{contratoId} { allow read, write: if isAdmin(); }

    // =================================================================
    // ‚úÖ COLE√á√ïES GLOBAIS COM ACESSO RESTRITO
    // =================================================================

    // üë§ USU√ÅRIOS/COLABORADORES GLOBAIS
    // Cada usu√°rio pode ler/escrever apenas seu pr√≥prio documento
    match /colaboradores/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow write: if isAdmin() || (request.auth != null && request.auth.uid == userId);
    }

    // =================================================================
    // üè¢ MULTI-TENANCY (DADOS POR EMPRESA)
    // =================================================================
    
    // 1Ô∏è‚É£ COLABORADORES DA EMPRESA (Perfil de Acesso)
    match /empresas/{empresaId}/entidades/colaboradores/items/{itemId} {
      // LEITURA:
      // 1. Admin Global
      // 2. Colegas da mesma empresa (para listar equipe)
      // 3. O pr√≥prio usu√°rio (bootstrapping via email match se claim falhar)
      allow read: if isAdmin() || 
                  belongsToCompany(empresaId) || 
                  (request.auth != null && request.auth.token.email == resource.data.email);

      // ESCRITA: Apenas Admin da Empresa ou Admin Global
      allow write: if isAdmin() || isCompanyAdmin(empresaId);
    }

    // 2Ô∏è‚É£ DADOS DA EMPRESA (Clientes, Acertos, Mesas, Rotas, etc.)
    // Regra: Deve ter a claim 'companyId' igual ao {empresaId} da URL
    match /empresas/{empresaId}/entidades/{collectionName}/items/{itemId} {
      allow read: if isAdmin() || belongsToCompany(empresaId);
      allow write: if isAdmin() || belongsToCompany(empresaId); 
    }
    
    // Regra Gen√©rica para subcole√ß√µes profundas da empresa
    match /empresas/{empresaId}/{document=**} {
      allow read: if isAdmin() || belongsToCompany(empresaId);
      allow write: if isAdmin() || isCompanyAdmin(empresaId); // Default write restricted to admins
    }

    // =================================================================
    // üèöÔ∏è COLE√á√ïES LEGADO (Ciclos, Despesas, Acertos Antigos)
    // Mantidas para compatibilidade, mas exigem autentica√ß√£o
    // =================================================================
    
    match /ciclos/{cicloId} {
      allow read, write: if request.auth != null; 
    }
    match /despesas/{despesaId} {
      allow read, write: if request.auth != null;
    }
    match /acertos/{acertoId} {
      allow read, write: if request.auth != null;
    }
    match /mesas/{mesaId} {
      allow read, write: if request.auth != null;
    }
    match /rotas/{rotaId}/{document=**} {
      allow read, write: if request.auth != null;
    }
    match /clientes/{clienteId}/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
