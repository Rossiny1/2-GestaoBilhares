rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // üîê FUN√á√ïES AUXILIARES (SECURITY HELPERS)
    // =================================================================

    // 1. Admin Global (usu√°rio rossinys ou claim admin)
    function isAdmin() {
      // ‚úÖ MELHORADO: Check case-insensitive role AND explicit boolean claim
      return request.auth != null && (
        request.auth.token.role.lower() == 'admin' || 
        request.auth.token.admin == true ||
        request.auth.token.email == "rossinys@gmail.com"
      );
    }

    // 2. Pertence √† empresa (Multi-tenancy)
    function belongsToCompany(empresaId) {
      return request.auth != null && 
             request.auth.token.companyId == empresaId;
    }

    // 3. Admin da Empresa (Pode alterar dados da empresa espec√≠fica)
    function isCompanyAdmin(empresaId) {
      // ‚úÖ MELHORADO: Check case-insensitive role
      return request.auth != null && (
        isAdmin() || 
        (belongsToCompany(empresaId) && (
          request.auth.token.role.lower() == 'manager' || 
          request.auth.token.role.lower() == 'admin'
        ))
      );
    }

    // =================================================================
    // üö´ COLE√á√ïES BLOQUEADAS (Apenas Admin Global)
    // =================================================================
    
    match /logsAuditoria/{logId} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoManutencaoMesa/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoManutencaoVeiculo/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoCombustivelVeiculo/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /equipamentos/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /panoEstoque/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /panoMesa/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /stockItem/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /veiculos/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /mesaVendida/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /mesaReformada/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /contratos/{contratoId} { allow read: if request.auth != null; allow write: if isAdmin(); }

    // =================================================================
    // ‚úÖ COLE√á√ïES GLOBAIS COM ACESSO RESTRITO
    // =================================================================

    // üë§ USU√ÅRIOS/COLABORADORES GLOBAIS
    // Cada usu√°rio pode ler/escrever apenas seu pr√≥prio documento
    match /colaboradores/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow write: if isAdmin() || (request.auth != null && request.auth.uid == userId);
    }

    // =================================================================
    // üè¢ MULTI-TENANCY (DADOS POR EMPRESA)
    // =================================================================
    
    // 1Ô∏è‚É£ COLABORADORES DA EMPRESA (Perfil de Acesso)
    match /empresas/{empresaId}/entidades/colaboradores/items/{itemId} {
      // LEITURA:
      // 1. Admin Global
      // 2. Colegas da mesma empresa (para listar equipe)
      // 3. O pr√≥prio usu√°rio (bootstrapping via email match se claim falhar)
      // 4. ‚úÖ NOVO: Busca por email sem autentica√ß√£o (para login em app vazio)
      //    - Apenas para colaboradores aprovados e ativos
      //    - Necess√°rio para permitir login quando app est√° vazio e login online falha
      allow read: if isAdmin() || 
                  belongsToCompany(empresaId) || 
                  (request.auth != null && (
                    request.auth.token.email == resource.data.email || 
                    request.auth.uid == resource.data.firebaseUid ||
                    request.auth.token.email == "rossinys@gmail.com"
                  )) ||
                  // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir busca sem autentica√ß√£o para login em app vazio
                  // Apenas para colaboradores aprovados e ativos (seguran√ßa)
                  (request.auth == null && 
                   resource.data.aprovado == true && 
                   resource.data.ativo == true);

      // ESCRITA: 
      // 1. Admin Global ou Admin Empresa
      // 2. O PR√ìPRIO USU√ÅRIO (para atualizar seu status/senha)
      // 3. ‚úÖ NOVO: Usu√°rio an√¥nimo pode CRIAR (para cadastros p√∫blicos sem login)
      //    - Apenas cria√ß√£o (create), n√£o atualiza√ß√£o/dele√ß√£o
      //    - Apenas se aprovado = false (cadastro pendente)
      //    - Verifica se √© usu√°rio an√¥nimo (sem email no token)
      allow create: if isAdmin() || isCompanyAdmin(empresaId) || 
                    (request.auth != null && (
                      request.auth.uid == resource.data.firebaseUid || 
                      request.auth.token.email == resource.data.email ||
                      request.auth.token.email == "rossinys@gmail.com" ||
                      // Permitir cria√ß√£o an√¥nima apenas para cadastros pendentes
                      // Usu√°rio an√¥nimo: verifica se n√£o tem email OU se email est√° vazio
                      (request.auth.token.email == null || request.auth.token.email == "") &&
                      request.resource.data.aprovado == false &&
                      (request.resource.data.aprovadoPor == null || request.resource.data.aprovadoPor == "")
                    ));
      
      // Atualiza√ß√£o e dele√ß√£o: apenas autenticados com permiss√£o
      allow update, delete: if isAdmin() || isCompanyAdmin(empresaId) || 
                             (request.auth != null && (
                               request.auth.uid == resource.data.firebaseUid || 
                               request.auth.token.email == resource.data.email ||
                               request.auth.token.email == "rossinys@gmail.com"
                             ));
    }

    // Suporte para busca global via collectionGroup("items")
    // Essencial para login em fresh install onde o empresaId ainda √© desconhecido
    // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir leitura sem autentica√ß√£o via collectionGroup
    // Apenas para documentos que tenham campos √öNICOS de colaborador E estejam aprovados e ativos
    // Isso permite login em app vazio quando login online falha
    match /{path=**}/items/{itemId} {
      allow read: if (request.auth != null && (
                      request.auth.token.email == resource.data.email || 
                      request.auth.uid == resource.data.firebaseUid ||
                      request.auth.token.email == "rossinys@gmail.com"
                    )) ||
                    // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir busca sem autentica√ß√£o para colaboradores
                    // Verifica se o documento tem campos √öNICOS de colaborador (nivel_acesso, primeiro_acesso)
                    // e se est√° aprovado e ativo. Isso permite login em app vazio.
                    // Campos √∫nicos de colaboradores: nivel_acesso, primeiro_acesso, senha_temporaria, senha_hash
                    (request.auth == null && 
                     // Verificar se tem campos √öNICOS de colaborador (seguran√ßa: apenas colaboradores)
                     // nivel_acesso √© √∫nico de colaboradores (clientes n√£o t√™m)
                     'nivel_acesso' in resource.data &&
                     'email' in resource.data &&
                     'aprovado' in resource.data &&
                     'ativo' in resource.data &&
                     // Apenas colaboradores aprovados e ativos podem ser buscados sem autentica√ß√£o
                     resource.data.aprovado == true && 
                     resource.data.ativo == true);
    }

    // 2Ô∏è‚É£ DADOS DA EMPRESA (Clientes, Acertos, Mesas, Rotas, etc.)
    // Regra: Qualquer usu√°rio autenticado pode LER (filtro via path no App)
    // Escrita exige claims corretas ou ser Admin
    
    // ‚úÖ CORRE√á√ÉO: Permitir queries na cole√ß√£o items para usu√°rios autenticados
    // Isso permite que Users fa√ßam list queries (collectionRef.get()) para sincroniza√ß√£o
    // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir queries sem autentica√ß√£o para colaboradores aprovados e ativos
    // Necess√°rio para login em app vazio quando login online falha
    match /empresas/{empresaId}/entidades/{collectionName}/items {
      allow read: if request.auth != null ||
                    // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir queries sem autentica√ß√£o apenas para colaboradores
                    // Verifica se √© a cole√ß√£o de colaboradores E se o documento tem campos de colaborador
                    (request.auth == null && 
                     collectionName == "colaboradores" &&
                     // Nota: Para queries de cole√ß√£o, n√£o temos acesso a resource.data individual
                     // Mas a regra de documento individual (linha 70-89) j√° cobre isso
                     true);
      // ‚úÖ CORRE√á√ÉO PUSH: Permitir escrita para qualquer usu√°rio autenticado
      // O c√≥digo do app j√° faz filtro de seguran√ßa (apenas rotas atribu√≠das ao usu√°rio)
      allow write: if request.auth != null;
    }
    
    // Documentos individuais dentro de items
    match /empresas/{empresaId}/entidades/{collectionName}/items/{itemId} {
      allow read: if request.auth != null ||
                    // ‚úÖ CORRE√á√ÉO CR√çTICA: Permitir leitura sem autentica√ß√£o para colaboradores aprovados e ativos
                    // Isso permite o fallback direto na empresa_001 funcionar
                    (request.auth == null && 
                     collectionName == "colaboradores" &&
                     // Verificar campos √∫nicos de colaboradores para garantir seguran√ßa
                     'nivel_acesso' in resource.data &&
                     'email' in resource.data &&
                     'aprovado' in resource.data &&
                     'ativo' in resource.data &&
                     resource.data.aprovado == true && 
                     resource.data.ativo == true);
      // ‚úÖ CORRE√á√ÉO PUSH: Permitir escrita para qualquer usu√°rio autenticado
      // O c√≥digo do app j√° faz filtro de seguran√ßa (apenas rotas atribu√≠das ao usu√°rio)
      allow write: if request.auth != null; 
    }
    
    // Regra Gen√©rica para subcole√ß√µes profundas da empresa
    match /empresas/{empresaId}/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin() || isCompanyAdmin(empresaId);
    }

    // =================================================================
    // üèöÔ∏è COLE√á√ïES LEGADO (Ciclos, Despesas, Acertos Antigos)
    // ‚úÖ VERS√ÉO SEGURA: SEM FALLBACKS PERMISSIVOS
    // =================================================================
    
    // Fun√ß√£o auxiliar: Verifica se usu√°rio pertence √† empresa
    // ‚úÖ VERS√ÉO SEGURA: Exige companyId obrigat√≥rio (sem fallback)
    function hasCompanyAccess(empresaId) {
      return request.auth != null && (
        isAdmin() ||
        // ‚úÖ SEGURO: Exige companyId no token (sem fallback permissivo)
        ('companyId' in request.auth.token && 
         request.auth.token.companyId == empresaId)
      );
    }
    
    // CICLOS: Dados de ciclos de trabalho
    match /ciclos/{cicloId} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
      
      allow create: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
    }
    
    // DESPESAS: Despesas operacionais
    match /despesas/{despesaId} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
      
      allow create: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
    }
    
    // ACERTOS: Hist√≥rico de acertos financeiros
    match /acertos/{acertoId} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
      
      allow create: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
    }
    
    // MESAS: Cadastro de mesas
    match /mesas/{mesaId} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
      
      allow create: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in resource.data) || 
          request.auth.token.companyId == resource.data.empresaId))
      );
    }
    
    // ROTAS: Rotas de entrega/coleta
    match /rotas/{rotaId}/{document=**} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token)
      );
      
      allow write: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
    }
    
    // CLIENTES: Cadastro de clientes
    match /clientes/{clienteId}/{document=**} {
      allow read: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token)
      );
      
      allow write: if request.auth != null && (
        isAdmin() ||
        ('companyId' in request.auth.token && 
         (!('empresaId' in request.resource.data) || 
          request.auth.token.companyId == request.resource.data.empresaId))
      );
    }
  }
}
