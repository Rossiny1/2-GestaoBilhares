rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════
    // HELPERS (Funções auxiliares)
    // ═══════════════════════════════════════════════════════

    function isAuthenticated() {
      return request.auth != null;
    }

    function belongsToCompany(empresaId) {
      // Verificar se usuário pertence à empresa
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid));
    }

    function belongsToUserRoute(empresaId, rotaId) {
      // Verificar se rota está nas permitidas do colaborador
      return belongsToCompany(empresaId) &&
             get(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid))
             .data.rotasPermitidas.hasAny([rotaId]);
    }

    function isAdmin(empresaId) {
      // Verificar se colaborador é admin da empresa
      return belongsToCompany(empresaId) &&
             get(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid))
             .data.nivel_acesso == "ADMIN";
    }

    function isApproved(empresaId) {
      // Verificar se colaborador está aprovado
      return belongsToCompany(empresaId) &&
             get(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid))
             .data.aprovado == true;
    }

    function isOwner(empresaId, userId) {
      // Verificar se o documento pertence ao usuário
      return isAuthenticated() && 
             request.auth.uid == userId;
    }

    // ═══════════════════════════════════════════════════════
    // COLLECTION: empresas (RAIZ)
    // ═══════════════════════════════════════════════════════

    match /empresas/{empresaId} {
      // Leitura da empresa: qualquer colaborador aprovado
      allow read: if isApproved(empresaId);

      // Escrita da empresa: apenas admins
      allow write: if isAdmin(empresaId);

      // ───────────────────────────────────────────────────
      // SUBCOLLECTION: colaboradores
      // ───────────────────────────────────────────────────

      match /colaboradores/{colaboradorId} {
        // Leitura: colaboradores da mesma empresa aprovados
        allow read: if belongsToCompany(empresaId) || isAdmin(empresaId);

        // Criação: qualquer autenticado pode se registrar (primeiro acesso)
        // O app cria com aprovado=false, admin aprova depois
        allow create: if isAuthenticated() && 
                         request.resource.data.firebase_uid == request.auth.uid &&
                         request.resource.data.empresa_id == empresaId;

        // Atualização: admin pode tudo, colaborador só pode alterar dados próprios (exceto campos críticos)
        allow update: if isAdmin(empresaId) || 
                         (request.auth.uid == resource.data.firebase_uid && 
                          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['nivel_acesso', 'rotasPermitidas', 'aprovado', 'empresa_id']));

        // Deleção: apenas admins
        allow delete: if isAdmin(empresaId);
      }

      // ───────────────────────────────────────────────────
      // SUBCOLLECTION: entidades
      // ───────────────────────────────────────────────────

      match /entidades/{collectionName} {
        // Leitura da collection: apenas colaboradores aprovados
        allow list: if isApproved(empresaId);

        // ─────────────────────────────────────────────────
        // SUBCOLLECTION: items (onde ficam os documentos reais)
        // ─────────────────────────────────────────────────

        match /items/{itemId} {
          // ═══════════════════════════════════════════════════════
          // REGRAS GERAIS PARA TODAS AS ENTIDADES
          // ═══════════════════════════════════════════════════════
          
          // ROTAS
          allow read, write: if collectionName == "rotas" && (
            // Leitura: colaboradores aprovados
            (request.method == 'get' && isApproved(empresaId)) ||
            // Escrita: apenas admins
            (request.method in ['create', 'update', 'delete'] && isAdmin(empresaId))
          );

          // CLIENTES
          allow read: if collectionName == "clientes" && 
                       isApproved(empresaId) && 
                       belongsToUserRoute(empresaId, resource.data.rota_id);
          
          allow create: if collectionName == "clientes" && 
                         isApproved(empresaId) && 
                         belongsToUserRoute(empresaId, request.resource.data.rota_id) &&
                         request.resource.data.empresa_id == empresaId;
          
          allow update: if collectionName == "clientes" && 
                         (isAdmin(empresaId) || 
                          (isApproved(empresaId) && 
                           belongsToUserRoute(empresaId, resource.data.rota_id) &&
                           request.resource.data.empresa_id == empresaId));
          
          allow delete: if collectionName == "clientes" && isAdmin(empresaId);

          // ACERTOS
          allow read: if collectionName == "acertos" && 
                       isApproved(empresaId) && 
                       belongsToUserRoute(empresaId, resource.data.rota_id);
          
          allow create: if collectionName == "acertos" && 
                         isApproved(empresaId) && 
                         belongsToUserRoute(empresaId, request.resource.data.rota_id) &&
                         request.resource.data.empresa_id == empresaId;
          
          allow update: if collectionName == "acertos" && 
                         (isAdmin(empresaId) || 
                          (isApproved(empresaId) && 
                           belongsToUserRoute(empresaId, resource.data.rota_id) &&
                           request.resource.data.empresa_id == empresaId));
          
          allow delete: if collectionName == "acertos" && isAdmin(empresaId);

          // MESAS
          allow read: if collectionName == "mesas" && 
                       isApproved(empresaId) && 
                       belongsToUserRoute(empresaId, resource.data.rota_id);
          
          allow create: if collectionName == "mesas" && 
                         isApproved(empresaId) && 
                         belongsToUserRoute(empresaId, request.resource.data.rota_id) &&
                         request.resource.data.empresa_id == empresaId;
          
          allow update: if collectionName == "mesas" && 
                         (isAdmin(empresaId) || 
                          (isApproved(empresaId) && 
                           belongsToUserRoute(empresaId, resource.data.rota_id) &&
                           request.resource.data.empresa_id == empresaId));
          
          allow delete: if collectionName == "mesas" && isAdmin(empresaId);

          // DESPESAS
          allow read: if collectionName == "despesas" && 
                       isApproved(empresaId) && 
                       belongsToUserRoute(empresaId, resource.data.rota_id);
          
          allow create: if collectionName == "despesas" && 
                         isApproved(empresaId) && 
                         belongsToUserRoute(empresaId, request.resource.data.rota_id) &&
                         request.resource.data.empresa_id == empresaId;
          
          allow update: if collectionName == "despesas" && 
                         (isAdmin(empresaId) || 
                          (isApproved(empresaId) && 
                           belongsToUserRoute(empresaId, resource.data.rota_id) &&
                           request.resource.data.empresa_id == empresaId));
          
          allow delete: if collectionName == "despesas" && isAdmin(empresaId);

          // OUTRAS ENTIDADES (fallback)
          allow read: if isApproved(empresaId);
          allow write: if isAdmin(empresaId);
        }
      }
    }

    // ═══════════════════════════════════════════════════════
    // FALLBACK: Negar tudo que não foi explicitamente permitido
    // ═══════════════════════════════════════════════════════

    match /{document=**} {
      allow read, write: if false;
    }
  }
}