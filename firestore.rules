rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üîê FUN√á√ÉO AUXILIAR: Verificar se usu√°rio √© ADMIN
    // ‚úÖ CORRE√á√ÉO: Verificar email do token ou permitir se autenticado (para login offline)
    function isAdmin() {
      return request.auth != null &&
             (request.auth.token.admin == true ||
              (request.auth.token.email != null && request.auth.token.email == "rossinys@gmail.com"));
    }

    // üîê FUN√á√ÉO AUXILIAR: Verificar se usu√°rio √© COLABORADOR APROVADO
    // ‚úÖ RESTAURADO: Vers√£o mais permissiva - qualquer usu√°rio autenticado
    function isApprovedCollaborator() {
      return request.auth != null; // Qualquer usu√°rio autenticado pode acessar
    }

    // üîê FUN√á√ÉO AUXILIAR: Verificar se usu√°rio tem acesso √† rota espec√≠fica
    function hasRouteAccess(rotaId) {
      return isAdmin() ||
             (isApprovedCollaborator() &&
              exists(/databases/$(database)/documents/colaboradores/$(request.auth.uid)/rotas/$(rotaId)));
    }

    // =================================================================
    // üö´ COLE√á√ïES BLOQUEADAS POR PADR√ÉO (requerem regras espec√≠ficas)
    // =================================================================

    // ‚ùå AUDITORIA - Apenas ADMIN
    match /logsAuditoria/{logId} {
      allow read, write: if isAdmin();
    }

    // ‚ùå HIST√ìRICOS DE MANUTEN√á√ÉO - Apenas ADMIN
    match /historicoManutencaoMesa/{item} {
      allow read, write: if isAdmin();
    }
    match /historicoManutencaoVeiculo/{item} {
      allow read, write: if isAdmin();
    }
    match /historicoCombustivelVeiculo/{item} {
      allow read, write: if isAdmin();
    }

    // ‚ùå EQUIPAMENTOS E ESTOQUE - Apenas ADMIN
    match /equipamentos/{item} {
      allow read, write: if isAdmin();
    }
    match /panoEstoque/{item} {
      allow read, write: if isAdmin();
    }
    match /panoMesa/{item} {
      allow read, write: if isAdmin();
    }
    match /stockItem/{item} {
      allow read, write: if isAdmin();
    }

    // ‚ùå VE√çCULOS - Apenas ADMIN
    match /veiculos/{item} {
      allow read, write: if isAdmin();
    }

    // ‚ùå MESAS VENDIDAS/REFORMADAS - Apenas ADMIN
    match /mesaVendida/{item} {
      allow read, write: if isAdmin();
    }
    match /mesaReformada/{item} {
      allow read, write: if isAdmin();
    }

    // =================================================================
    // ‚úÖ COLE√á√ïES COM ACESSO CONTROLADO
    // =================================================================

    // üë• COLABORADORES - ADMIN pode tudo, usu√°rios podem ler seu pr√≥prio perfil
    match /colaboradores/{userId} {
      allow read: if request.auth != null;
      allow write: if isAdmin() ||
                   (request.auth != null && request.auth.uid == userId);
    }

    // üë• COLABORADORES (ESTRUTURA EMPRESAS) - Permitir busca por email para login
    // Estrutura: empresas/empresa_001/entidades/colaboradores/items
    // ‚ö†Ô∏è SEGURAN√áA TEMPOR√ÅRIA: allow read: if true
    // MOTIVO: Necess√°rio para login em app vazio (sem dados locais, sem auth token)
    // RISCO: Dados de colaboradores (emails, nomes, senhas hash) expostos publicamente
    // MITIGA√á√ÉO: Implementar Cloud Function para autentica√ß√£o na pr√≥xima vers√£o
    // TODO (Q2 2026): Substituir por endpoint seguro /auth/login
    match /empresas/{empresaId}/entidades/colaboradores/items/{itemId} {
      // ‚ö†Ô∏è PERMITIR LEITURA para todos (incluindo n√£o autenticados) para login
      // A busca por email √© necess√°ria quando o app est√° vazio
      allow read: if true; // TEMPOR√ÅRIO - Risco de seguran√ßa documentado
      // ‚úÖ PERMITIR ESCRITA apenas para usu√°rios autenticados (sincroniza√ß√£o)
      allow write: if request.auth != null;
    }

    // üè¢ CLIENTES - ADMIN pode tudo, COLABORADORES autenticados podem ler e escrever (incluindo DELETE)
    match /clientes/{clienteId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin() || request.auth != null; // ‚úÖ CORRE√á√ÉO: Usu√°rios autenticados podem criar, atualizar e deletar
    }

    // üõ£Ô∏è ROTAS - ADMIN pode tudo, COLABORADORES autenticados podem ler todas
    match /rotas/{rotaId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin();
    }

    // ‚úÖ CR√çTICO: Regra para estrutura aninhada empresas/empresa_001/entidades/{collectionName}/items
    // Esta √© a estrutura REAL usada pelo SyncRepository e AuthViewModel
    // Caminho: empresas/empresa_001/entidades/{collectionName}/items/{itemId}
    // ‚ö†Ô∏è SEGURAN√áA TEMPOR√ÅRIA: allow read: if true
    // MOTIVO: Necess√°rio para login em app vazio E sincroniza√ß√£o inicial
    // RISCO ALTO: Exp√µe TODAS entidades (clientes, acertos, mesas, despesas, colaboradores)
    // MITIGA√á√ÉO: Implementar Cloud Function + custom claims na pr√≥xima vers√£o
    // TODO (Q2 2026): Implementar autentica√ß√£o servidor-side e custom claims
    match /empresas/{empresaId}/entidades/{collectionName}/items/{itemId} {
      // ‚ö†Ô∏è CORRE√á√ÉO CR√çTICA: Permitir leitura SEM autentica√ß√£o para login em app vazio
      // Quando o app est√° vazio, o usu√°rio precisa buscar colaborador por email ANTES de autenticar
      // Mas tamb√©m funciona DEPOIS da autentica√ß√£o Firebase (quando request.auth != null)
      allow read: if true; // TEMPOR√ÅRIO - Risco ALTO documentado no roadmap
      // ‚úÖ CORRE√á√ÉO: Permitir write (CREATE, UPDATE, DELETE) para usu√°rios autenticados em cole√ß√µes comuns
      // ADMIN pode tudo, usu√°rios autenticados podem modificar despesas, acertos, clientes, etc.
      allow write: if isAdmin() ||
                   (request.auth != null && 
                    (collectionName == "colaboradores" || 
                     collectionName == "despesas" ||
                     collectionName == "acertos" ||
                     collectionName == "clientes" ||
                     collectionName == "mesas" ||
                     collectionName == "ciclos"));
    }
    
    // ‚úÖ CORRE√á√ÉO: Regra gen√©rica para subcole√ß√µes de empresas (caso haja outras estruturas)
    // IMPORTANTE: Esta regra vem DEPOIS da regra espec√≠fica acima, ent√£o n√£o interfere
    // ‚ö†Ô∏è SEGURAN√áA TEMPOR√ÅRIA: allow read: if true
    // MOTIVO: Fallback para estruturas n√£o capturadas pela regra espec√≠fica acima
    // RISCO: Backup de seguran√ßa mas ainda exp√µe dados
    // TODO (Q2 2026): Revisar e restringir ap√≥s implementar Cloud Functions
    match /empresas/{empresaId}/{document=**} {
      // ‚ö†Ô∏è PERMITIR LEITURA sem autentica√ß√£o para permitir login em app vazio
      // A busca de colaboradores por email precisa funcionar mesmo sem autentica√ß√£o inicial
      allow read: if true; // TEMPOR√ÅRIO - Risco documentado
      allow write: if isAdmin();
    }

    // üìä CICLOS - ADMIN pode tudo, COLABORADORES autenticados podem ler e escrever (incluindo DELETE)
    match /ciclos/{cicloId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin() || request.auth != null; // ‚úÖ CORRE√á√ÉO: Usu√°rios autenticados podem criar, atualizar e deletar
    }

    // üí∞ DESPESAS - ADMIN pode tudo, COLABORADORES autenticados podem ler e escrever (incluindo DELETE)
    match /despesas/{despesaId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin() || request.auth != null; // ‚úÖ CORRE√á√ÉO: Usu√°rios autenticados podem criar, atualizar e deletar
    }

    // üìã ACERTOS - ADMIN pode tudo, COLABORADORES autenticados podem ler e escrever (incluindo DELETE)
    match /acertos/{acertoId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin() || request.auth != null; // ‚úÖ CORRE√á√ÉO: Usu√°rios autenticados podem criar, atualizar e deletar
    }

    // ü™ë MESAS - ADMIN pode tudo, COLABORADORES autenticados podem ler e escrever (incluindo DELETE)
    match /mesas/{mesaId} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin() || request.auth != null; // ‚úÖ CORRE√á√ÉO: Usu√°rios autenticados podem criar, atualizar e deletar
    }

    // üìÑ CONTRATOS - Apenas ADMIN (documentos sens√≠veis)
    match /contratos/{contratoId} {
      allow read, write: if isAdmin();
    }

    // üéØ METAS - ADMIN pode tudo, COLABORADORES podem ler suas pr√≥prias metas
    match /metas/{metaId} {
      allow read: if isAdmin() ||
                  (isApprovedCollaborator() &&
                   get(/databases/$(database)/documents/metas/$(metaId)).data.colaboradorId == request.auth.uid);
      allow write: if isAdmin();
    }

    // =================================================================
    // üèóÔ∏è SUBCOLE√á√ïES (seguem regras da cole√ß√£o pai)
    // =================================================================

    // Subcole√ß√µes de rotas (mesas, clientes, etc.)
    match /rotas/{rotaId}/{document=**} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin();
    }

    // Subcole√ß√µes de clientes
    match /clientes/{clienteId}/{document=**} {
      allow read: if request.auth != null; // ‚úÖ RESTAURADO: Qualquer usu√°rio autenticado pode ler
      allow write: if isAdmin();
    }

    // Subcole√ß√µes de colaboradores (rotas atribu√≠das)
    match /colaboradores/{userId}/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin() ||
                   (request.auth != null && request.auth.uid == userId);
    }
  }
}
