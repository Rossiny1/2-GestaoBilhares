rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // üîê FUN√á√ïES AUXILIARES (SECURITY HELPERS)
    // =================================================================

    // 1. Admin Global (usu√°rio rossinys ou claim admin)
    function isAdmin() {
      // ‚úÖ MELHORADO: Check case-insensitive role AND explicit boolean claim
      return request.auth != null && (
        request.auth.token.role.lower() == 'admin' || 
        request.auth.token.admin == true ||
        request.auth.token.email == "rossinys@gmail.com"
      );
    }

    // 2. Pertence √† empresa (Multi-tenancy)
    function belongsToCompany(empresaId) {
      return request.auth != null && 
             request.auth.token.companyId == empresaId;
    }

    // 3. Admin da Empresa (Pode alterar dados da empresa espec√≠fica)
    function isCompanyAdmin(empresaId) {
      // ‚úÖ MELHORADO: Check case-insensitive role
      return request.auth != null && (
        isAdmin() || 
        (belongsToCompany(empresaId) && (
          request.auth.token.role.lower() == 'manager' || 
          request.auth.token.role.lower() == 'admin'
        ))
      );
    }

    // =================================================================
    // üö´ COLE√á√ïES BLOQUEADAS (Apenas Admin Global)
    // =================================================================
    
    match /logsAuditoria/{logId} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoManutencaoMesa/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoManutencaoVeiculo/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /historicoCombustivelVeiculo/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /equipamentos/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /panoEstoque/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /panoMesa/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /stockItem/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /veiculos/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /mesaVendida/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /mesaReformada/{item} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /contratos/{contratoId} { allow read: if request.auth != null; allow write: if isAdmin(); }

    // =================================================================
    // ‚úÖ COLE√á√ïES GLOBAIS COM ACESSO RESTRITO
    // =================================================================

    // üë§ USU√ÅRIOS/COLABORADORES GLOBAIS
    // Cada usu√°rio pode ler/escrever apenas seu pr√≥prio documento
    match /colaboradores/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow write: if isAdmin() || (request.auth != null && request.auth.uid == userId);
    }

    // =================================================================
    // üè¢ MULTI-TENANCY (DADOS POR EMPRESA)
    // =================================================================
    
    // 1Ô∏è‚É£ COLABORADORES DA EMPRESA (Perfil de Acesso)
    match /empresas/{empresaId}/entidades/colaboradores/items/{itemId} {
      // LEITURA:
      // 1. Admin Global
      // 2. Colegas da mesma empresa (para listar equipe)
      // 3. O pr√≥prio usu√°rio (bootstrapping via email match se claim falhar)
      allow read: if isAdmin() || 
                  belongsToCompany(empresaId) || 
                  (request.auth != null && (
                    request.auth.token.email == resource.data.email || 
                    request.auth.uid == resource.data.firebaseUid ||
                    request.auth.token.email == "rossinys@gmail.com"
                  ));

      // ESCRITA: 
      // 1. Admin Global ou Admin Empresa
      // 2. O PR√ìPRIO USU√ÅRIO (para atualizar seu status/senha)
      // 3. ‚úÖ NOVO: Usu√°rio an√¥nimo pode CRIAR (para cadastros p√∫blicos sem login)
      //    - Apenas cria√ß√£o (create), n√£o atualiza√ß√£o/dele√ß√£o
      //    - Apenas se aprovado = false (cadastro pendente)
      //    - Verifica se √© usu√°rio an√¥nimo (sem email no token)
      allow create: if isAdmin() || isCompanyAdmin(empresaId) || 
                    (request.auth != null && (
                      request.auth.uid == resource.data.firebaseUid || 
                      request.auth.token.email == resource.data.email ||
                      request.auth.token.email == "rossinys@gmail.com" ||
                      // Permitir cria√ß√£o an√¥nima apenas para cadastros pendentes
                      // Usu√°rio an√¥nimo: verifica se n√£o tem email OU se email est√° vazio
                      (request.auth.token.email == null || request.auth.token.email == "") &&
                      request.resource.data.aprovado == false &&
                      (request.resource.data.aprovadoPor == null || request.resource.data.aprovadoPor == "")
                    ));
      
      // Atualiza√ß√£o e dele√ß√£o: apenas autenticados com permiss√£o
      allow update, delete: if isAdmin() || isCompanyAdmin(empresaId) || 
                             (request.auth != null && (
                               request.auth.uid == resource.data.firebaseUid || 
                               request.auth.token.email == resource.data.email ||
                               request.auth.token.email == "rossinys@gmail.com"
                             ));
    }

    // Suporte para busca global via collectionGroup("items")
    // Essencial para login em fresh install onde o empresaId ainda √© desconhecido
    match /{path=**}/items/{itemId} {
      allow read: if request.auth != null && (
        request.auth.token.email == resource.data.email || 
        request.auth.uid == resource.data.firebaseUid ||
        request.auth.token.email == "rossinys@gmail.com"
      );
    }

    // 2Ô∏è‚É£ DADOS DA EMPRESA (Clientes, Acertos, Mesas, Rotas, etc.)
    // Regra: Qualquer usu√°rio autenticado pode LER (filtro via path no App)
    // Escrita exige claims corretas ou ser Admin
    
    // ‚úÖ CORRE√á√ÉO: Permitir queries na cole√ß√£o items para usu√°rios autenticados
    // Isso permite que Users fa√ßam list queries (collectionRef.get()) para sincroniza√ß√£o
    match /empresas/{empresaId}/entidades/{collectionName}/items {
      allow read: if request.auth != null;
      // ‚úÖ CORRE√á√ÉO PUSH: Permitir escrita para qualquer usu√°rio autenticado
      // O c√≥digo do app j√° faz filtro de seguran√ßa (apenas rotas atribu√≠das ao usu√°rio)
      allow write: if request.auth != null;
    }
    
    // Documentos individuais dentro de items
    match /empresas/{empresaId}/entidades/{collectionName}/items/{itemId} {
      allow read: if request.auth != null;
      // ‚úÖ CORRE√á√ÉO PUSH: Permitir escrita para qualquer usu√°rio autenticado
      // O c√≥digo do app j√° faz filtro de seguran√ßa (apenas rotas atribu√≠das ao usu√°rio)
      allow write: if request.auth != null; 
    }
    
    // Regra Gen√©rica para subcole√ß√µes profundas da empresa
    match /empresas/{empresaId}/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin() || isCompanyAdmin(empresaId);
    }

    // =================================================================
    // üèöÔ∏è COLE√á√ïES LEGADO (Ciclos, Despesas, Acertos Antigos)
    // ‚úÖ MELHORADO: Regras mais seguras com fallbacks para evitar PERMISSION_DENIED
    // Estrat√©gia: Verifica√ß√µes opcionais quando claims dispon√≠veis + fallback seguro
    // =================================================================
    
    // Fun√ß√£o auxiliar: Verifica se usu√°rio pertence √† empresa (quando claim dispon√≠vel)
    // ‚úÖ ESTRAT√âGIA SEGURA: Sempre permite se n√£o houver claim (fallback para compatibilidade)
    // Isso garante que usu√°rios sem claims configurados ainda possam sincronizar
    function hasCompanyAccess(empresaId) {
      return request.auth != null && (
        // Admin sempre tem acesso
        isAdmin() ||
        // ‚úÖ FALLBACK SEGURO: Se n√£o tem claim de empresa, permite (evita PERMISSION_DENIED)
        !('companyId' in request.auth.token) ||
        // Se tem claim, verifica se pertence √† empresa
        request.auth.token.companyId == empresaId
      );
    }
    
    // CICLOS: Dados de ciclos de trabalho
    match /ciclos/{cicloId} {
      // Leitura: Qualquer usu√°rio autenticado (com fallback seguro)
      allow read: if request.auth != null;
      
      // Escrita: Verifica empresa quando poss√≠vel, mas mant√©m fallback
      allow create: if request.auth != null && (
        isAdmin() ||
        // Se n√£o tem claim de empresa, permite (fallback)
        !('companyId' in request.auth.token) ||
        // Se tem claim, verifica empresa no documento
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        // Se n√£o tem claim de empresa, permite (fallback)
        !('companyId' in request.auth.token) ||
        // Se tem claim, verifica empresa no documento existente
        !('empresaId' in resource.data) ||
        hasCompanyAccess(resource.data.empresaId)
      );
    }
    
    // DESPESAS: Despesas operacionais
    match /despesas/{despesaId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in resource.data) ||
        hasCompanyAccess(resource.data.empresaId)
      );
    }
    
    // ACERTOS: Hist√≥rico de acertos financeiros
    match /acertos/{acertoId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in resource.data) ||
        hasCompanyAccess(resource.data.empresaId)
      );
    }
    
    // MESAS: Cadastro de mesas
    match /mesas/{mesaId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
      
      allow update, delete: if request.auth != null && (
        isAdmin() ||
        !('companyId' in request.auth.token) ||
        !('empresaId' in resource.data) ||
        hasCompanyAccess(resource.data.empresaId)
      );
    }
    
    // ROTAS: Rotas de entrega/coleta
    // ‚úÖ NOTA: O app j√° filtra por rotas atribu√≠das no c√≥digo (SyncRepository)
    // As regras aqui apenas garantem autentica√ß√£o b√°sica com fallback seguro
    match /rotas/{rotaId}/{document=**} {
      // Leitura: Qualquer usu√°rio autenticado (o app filtra por rotas no c√≥digo)
      allow read: if request.auth != null;
      
      // Escrita: Verifica empresa quando poss√≠vel, mas mant√©m fallback seguro
      allow write: if request.auth != null && (
        isAdmin() ||
        // ‚úÖ FALLBACK SEGURO: Se n√£o tem claim de empresa, permite (evita PERMISSION_DENIED)
        !('companyId' in request.auth.token) ||
        // Se tem claim, verifica empresa (se existir no documento)
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
    }
    
    // CLIENTES: Cadastro de clientes
    // ‚úÖ NOTA: O app j√° filtra por rotas atribu√≠das no c√≥digo (SyncRepository)
    // As regras aqui apenas garantem autentica√ß√£o b√°sica com fallback seguro
    match /clientes/{clienteId}/{document=**} {
      // Leitura: Qualquer usu√°rio autenticado (o app filtra por rotas no c√≥digo)
      allow read: if request.auth != null;
      
      // Escrita: Verifica empresa quando poss√≠vel, mas mant√©m fallback seguro
      allow write: if request.auth != null && (
        isAdmin() ||
        // ‚úÖ FALLBACK SEGURO: Se n√£o tem claim de empresa, permite (evita PERMISSION_DENIED)
        !('companyId' in request.auth.token) ||
        // Se tem claim, verifica empresa (se existir no documento)
        !('empresaId' in request.resource.data) ||
        hasCompanyAccess(request.resource.data.empresaId)
      );
    }
  }
}
