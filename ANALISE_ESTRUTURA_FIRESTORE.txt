# ğŸ“Š ANÃLISE DA ESTRUTURA REAL DO FIRESTORE

> **Data:** 27/01/2026  
> **Fonte:** CÃ³digo Kotlin do projeto  
> **Status:** Estrutura hierÃ¡rquica confirmada

---

## ğŸ¯ **ESTRUTURA MAPEADA**

### **Path Completo para Colaboradores:**
```kotlin
// CÃ³digo encontrado em mÃºltiplos arquivos:
val docRef = firestore
    .collection("empresas")
    .document(empresaId)  // ou "empresa_001"
    .collection("colaboradores")
    .document(uid)

// Path esperado: empresas/{empresaId}/colaboradores/{uid}
```

**Arquivos que usam este path:**
- `ColaboradorManagementViewModel.kt` (linhas 229-230, 246-249)
- `AuthViewModel.kt` (linhas 313-314, 1606-1608, 1891-1893, 2041-2042)
- `ColaboradorFirestoreRepository.kt` (linhas 42-44, 148-150, 222-224, 267-269)
- `AppRepository.kt` (linhas 809-811, 930-932)
- `ColaboradorSyncHandler.kt` (linhas 49-51)

---

### **Path Completo para Entidades:**
```kotlin
// CÃ³digo encontrado em BaseSyncHandler:
return firestore
    .collection(COLLECTION_EMPRESAS)
    .document(companyId)
    .collection("entidades")
    .document(collectionName)
    .collection("items")

// Path esperado: empresas/{empresaId}/entidades/{collectionName}/items/{id}
```

**Arquivos que usam este path:**
- `BaseSyncHandler.kt` (linhas 138-143)
- `LoginDiagnostics.kt` (linhas 110-114)
- `diagnostico-login-firestore.kt` (linhas 75-79, 106-110)

**Collections em "entidades":**
- `rotas` â†’ empresas/{empresaId}/entidades/rotas/items/{id}
- `clientes` â†’ empresas/{empresaId}/entidades/clientes/items/{id}
- `acertos` â†’ empresas/{empresaId}/entidades/acertos/items/{id}
- `mesas` â†’ empresas/{empresaId}/entidades/mesas/items/{id}

---

## ğŸ” **ESTRUTURA COMPLETA CONFIRMADA**

```
empresas/
â””â”€ {empresaId}/ (ex: "empresa_001")
   â”œâ”€ colaboradores/
   â”‚  â””â”€ {uid}/
   â”‚     â”œâ”€ firebase_uid
   â”‚     â”œâ”€ nome
   â”‚     â”œâ”€ email
   â”‚     â”œâ”€ rotasPermitidas
   â”‚     â”œâ”€ nivel_acesso
   â”‚     â”œâ”€ aprovado
   â”‚     â””â”€ ...
   â””â”€ entidades/
      â”œâ”€ rotas/
      â”‚  â””â”€ items/
      â”‚     â””â”€ {rotaId}/
      â”‚        â”œâ”€ nome
      â”‚        â”œâ”€ ativa
      â”‚        â””â”€ ...
      â”œâ”€ clientes/
      â”‚  â””â”€ items/
      â”‚     â””â”€ {clienteId}/
      â”‚        â”œâ”€ nome
      â”‚        â”œâ”€ rotaId
      â”‚        â””â”€ ...
      â”œâ”€ acertos/
      â”‚  â””â”€ items/
      â”‚     â””â”€ {acertoId}/
      â”‚        â”œâ”€ valor
      â”‚        â”œâ”€ rotaId
      â”‚        â””â”€ ...
      â””â”€ mesas/
         â””â”€ items/
            â””â”€ {mesaId}/
               â”œâ”€ numero
               â”œâ”€ rotaId
               â””â”€ ...
```

---

## âŒ **ESTRUTURA INCORRETA (IMPLEMENTADA ANTES)**

```
clientes/ (raiz) âŒ
acertos/ (raiz) âŒ
mesas/ (raiz) âŒ
rotas/ (raiz) âŒ
usuarios/ (raiz) âŒ
```

---

## âœ… **ESTRUTURA CORRETA (PROJETO REAL)**

```
empresas/empresa_001/colaboradores/{uid} âœ…
empresas/empresa_001/entidades/rotas/items/{id} âœ…
empresas/empresa_001/entidades/clientes/items/{id} âœ…
empresas/empresa_001/entidades/acertos/items/{id} âœ…
empresas/empresa_001/entidades/mesas/items/{id} âœ…
```

---

## ğŸ“‹ **CONSTANTES IMPORTANTES**

```kotlin
// BaseSyncHandler.kt
const val COLLECTION_EMPRESAS = "empresas"
const val COLLECTION_COLABORADORES = "colaboradores"

// Sync usa empresas/{empresaId}/entidades/{collectionName}/items/{id}
```

---

## ğŸ¯ **CONCLUSÃƒO DA ANÃLISE**

### **âœ… Confirmado:**
1. **Estrutura hierÃ¡rquica** com `empresas/{empresaId}/` como raiz
2. **Colaboradores** em `empresas/{empresaId}/colaboradores/{uid}`
3. **Entidades** em `empresas/{empresaId}/entidades/{collectionName}/items/{id}`
4. **Multi-tenancy** por empresa + rota (nÃ£o apenas por rota)

### **âŒ Problema Original:**
- Security Rules criadas para estrutura flat
- App usa estrutura hierÃ¡rquica completa
- PERMISSION_DENIED para todas as operaÃ§Ãµes

### **ğŸ”§ CorreÃ§Ã£o NecessÃ¡ria:**
- Reescrever Security Rules para estrutura hierÃ¡rquica
- Implementar validaÃ§Ã£o por empresa + rota
- Manter compatibilidade com cÃ³digo existente

---

## ğŸ“ **NOTAS PARA IMPLEMENTAÃ‡ÃƒO**

1. **Empresa ID fixo:** `empresa_001` (hardcoded em vÃ¡rios lugares)
2. **Collections entidades:** Sempre usam subcollection `items`
3. **Multi-tenancy real:** Por empresa + rota (nÃ£o apenas rota)
4. **Colaboradores:** Diretamente sob empresa (sem `items`)

---

*AnÃ¡lise concluÃ­da - Estrutura hierÃ¡rquica confirmada*