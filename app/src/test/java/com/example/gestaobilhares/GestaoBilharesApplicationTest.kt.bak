package com.example.gestaobilhares

import android.app.Application
import androidx.test.core.app.ApplicationProvider
import com.google.truth.Truth.assertThat
import org.junit.Before
import org.junit.Test

/**
 * Testes unitários para GestaoBilharesApplication.
 * Valida inicialização do Hilt, Firebase e configurações básicas.
 */
class GestaoBilharesApplicationTest {
    
    private lateinit var application: GestaoBilharesApplication
    
    @Before
    fun setup() {
        application = ApplicationProvider.getApplicationContext() as GestaoBilharesApplication
    }
    
    @Test
    fun `application deve ser inicializada corretamente`() {
        // GIVEN: Application obtida do contexto de teste
        
        // WHEN: Verificação da instância
        val context = ApplicationProvider.getApplicationContext<Application>()
        
        // THEN: Application deve ser não nula e do tipo correto
        assertThat(context).isNotNull()
        assertThat(context).isInstanceOf(GestaoBilharesApplication::class.java)
        assertThat(application.packageName).isEqualTo("com.example.gestaobilhares")
    }
    
    @Test
    fun `singleton instance deve funcionar corretamente`() {
        // GIVEN: Application inicializada
        
        // WHEN: Obter instância via companion object
        val instance = GestaoBilharesApplication.getInstance()
        
        // THEN: Deve retornar a mesma instância
        assertThat(instance).isNotNull()
        assertThat(instance).isEqualTo(application)
    }
    
    @Test
    fun `application deve ser thread-safe`() {
        // GIVEN: Múltiplas threads acessando a instância
        
        // WHEN: Acessar instância concorrentemente
        val results = mutableListOf<GestaoBilharesApplication>()
        val threads = (1..5).map {
            Thread {
                results.add(GestaoBilharesApplication.getInstance())
            }
        }
        
        threads.forEach { it.start() }
        threads.forEach { it.join() }
        
        // THEN: Todas as threads devem obter a mesma instância
        assertThat(results).hasSize(5)
        results.forEach { instance ->
            assertThat(instance).isEqualTo(application)
        }
    }
    
    @Test
    fun `getInstance deve lancar excecao se application nao inicializada`() {
        // GIVEN: Reset da instância (simulando estado não inicializado)
        // Nota: Não podemos resetar a instância real, então vamos testar o comportamento esperado
        
        // WHEN/THEN: A instância atual deve funcionar normalmente
        assertThat(GestaoBilharesApplication.getInstance()).isNotNull()
        
        // Em cenário real onde INSTANCE é null, lançaria IllegalStateException
        // Mas não podemos testar isso sem modificar o código fonte
    }
}